---
title: "Compound names and descriptors"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(webchem)
library(readxl)
```

# Purpose

To get better names, literature RIs, and flavor descriptors for compounds used in both years combined

# Load Data

```{r data, echo=TRUE}
gc2017 <- read_rds(here("data", "cleaned", "2017_gcms_tidy.rds"))
gc2018 <- read_rds(here("data", "cleaned", "2018_gcms_tidy.rds"))
```

For now, just get CAS and Compound

```{r}
compounds2017 <- gc2017 %>% group_by(Compound, CAS) %>% count() %>% select(-n)
compounds2018 <- gc2018 %>% group_by(Compound, CAS) %>% count() %>% select(-n)
df <- full_join(compounds2017, compounds2018)
```
# Get better names
pc_synonyms doesn't take CAS numbers directly.
```{r eval=FALSE}
df2 <-
  df %>% 
  mutate(inchikey = ifelse(is.na(CAS), NA, cts_convert(CAS, from = "CAS", to = "InChIKey", choices = 1)))

df3 <-
  df2 %>% 
  mutate(pretty_name = ifelse(is.na(inchikey), NA, pc_synonyms(inchikey, from = "inchikey", choices = 10)))
View(df3)
write_excel_csv(df3, here("data", "raw", "compound CAS and names.csv"))
```

You should compare this with names you used from the BACE paper before doing a ton of editing by hand.


# Merge with BACE data

```{r}
bacedf <- read_excel(here("data", "raw", "Compound annotation.xlsx"))
newdf <- read_csv(here("data", "raw", "compound CAS and names.csv"))
fulldf <-
  left_join(newdf, bacedf) %>% 
  mutate(flavornet = ifelse(is.na(flavornet) & !is.na(CAS), fn_percept(CAS), flavornet))
cass <- fulldf %>% 
  filter(!is.na(CAS), is.na(`RI Lit`)) %>% pull(CAS)

missing_lit_ri <- nist_ri(cass, type = "linear", polarity = "non-polar", temp_prog = "ramp")

nearest <- function(x, y){
  dist <- abs(x - y)
  return(y[dist == min(dist)])
}

new_lit_ris <-
  missing_lit_ri %>% 
  filter(thickness == 0.25,
         length == 30,
         gas == "Helium",
         str_detect(phase, "5MS")) %>% 
  group_by(CAS) %>% 
  filter(RI == nearest(mean(RI), RI)) %>% #only use the RI closest to the mean of all the reported lit RIs
  summarize(RI = first(RI)) %>% #if that's more than one reference, just pick the first one
  select(CAS, RI)

fulldf2 <-
  left_join(fulldf, new_lit_ris) %>% 
  mutate(Source = ifelse(is.na(`RI Lit`) & !is.na(RI), "NIST", Source)) %>% 
  mutate(`RI Lit` = ifelse(is.na(`RI Lit`), RI, `RI Lit`)) %>% 
  select(-RI)

#try again using normal alkane

cass2 <- fulldf2 %>% filter(is.na(`RI Lit`) & !is.na(CAS)) %>% pull(CAS)

missing_lit_ri2 <- nist_ri(cass2, type = "alkane", polarity = "non-polar", temp_prog = "ramp")

new_lit_ris2 <- missing_lit_ri2 %>% 
  filter(thickness == 0.25,
         length == 30,
         gas == "Helium",
         str_detect(phase, "5MS")) %>% 
  group_by(CAS) %>% 
  summarize(RI = first(RI))

fulldf3 <-
  left_join(fulldf2, new_lit_ris2) %>% 
  mutate(Source = ifelse(is.na(`RI Lit`) & !is.na(RI), "NIST", Source)) %>% 
  mutate(`RI Lit` = ifelse(is.na(`RI Lit`), RI, `RI Lit`)) %>% 
  select(-RI)
fulldf3 %>% filter(str_detect(Compound, "tau"))
```

```{r}
write_excel_csv(fulldf3, here("data", "cleaned", "Compound annotation updated.csv"))
```

Ok, manual editing after this

$(E)$-$\beta$-Ocimene

$$
p = \mathit{p}
$$
```{r}
gc2018 %>% filter(Compound == "1-Hexanol", sample == "J21")
gc2018 %>% filter(Compound == "1-Hexanol", sample == "J7")

```

