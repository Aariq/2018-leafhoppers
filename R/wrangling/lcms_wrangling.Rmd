---
title: "LCMS wrangling"
output: html_notebook
---

Date initiated: 2019-05-08
Date last compiled: `r Sys.Date()`

#TODO:

- Fix problem in `2018 image processing.Rmd` that makes the `sample` and `plant_num` columns not uniform.  `sample` should be "Q12", `plant_num` should be "12".


```{r}
library(tidyverse)
library(here)
library(janitor)
library(chemhelper) #might not need?
library(readxl)
# library(tidyselect)
```

# Import Data

This is a very very ugly spreadsheet.  The sample names and data are not really easily combined.  I think I'll read them in separately and combine later?

## LCMS data

```{r}
lcms_data.raw <- read_excel(here("data", "raw", "Tea_LCMS_Report_050719.xlsx"), 
                        range = "C16:GF31")
lcms_data <-
  lcms_data.raw %>%
  slice(-1) %>% #remove blank row
  clean_names() %>% 
  select(-(2:10)) #get rid of compound metadata
```

Now capture sample names

```{r}
sample_names <- read_excel(here("data", "raw", "Tea_LCMS_Report_050719.xlsx"), 
    range = "M4:GF5")


colnames(lcms_data) <- c("compound", colnames(sample_names))
```


get rid of flags columns and gather

```{r}
lcms_tidy <-
  lcms_data %>% 
  select(-starts_with("...")) %>% #flags columns, not important
  gather(-compound, key = "sample", value = "conc") %>% 
  mutate(conc = as.numeric(conc)) %>%  #NAs are non-detects. need to deal with later.
  filter(!str_detect(sample, "blank"), !str_detect(sample, "Tea_Std")) #remove blanks and standards
```

# Create columns for cultivar and plant number

```{r}
lcms_tidy <-
  lcms_tidy %>% 
  mutate(cultivar = str_extract(sample, "^\\D")) %>% 
  mutate(plant_num = str_extract(sample, "\\d+")) %>% 
  select(compound, sample, cultivar, plant_num, conc)
```

# Deal with duplicates

For Q14--Q20 the samples were run twice.  Josh ran out of nitrogen for a few weeks and when he got more, he ran diluted samples that had been kept at -4º as well as new dilutions from samples that had been kept at -80º.  He said the -80 storage (Q##_2) look more similar to the other samples and I should probably use those.  It looks like there was a storage effect for theanine, caffeine, and ECG (and maybe EGCG)

```{r}
lcms_tidy %>% 
  filter(sample %in% c("Q14", "Q14_2", "Q15", "Q15_2", "Q16", "Q16_2", "Q17", "Q17_2", "Q18", "Q18_2", "Q19", "Q19_2", "Q20", "Q20_2")) %>% 
ggplot(aes(x = sample, y = conc)) +
  geom_point() +
  facet_wrap(~compound)
```

```{r}
lcms_tidy <-
  lcms_tidy %>% 
  filter(!sample %in% c(paste0("Q", 14:20))) %>% 
  mutate(sample = str_remove(sample, "_\\d"))
```

# Divide by leaf powder ammount

Josh's data is in µg/mL and he said he accounted for the 10.1 dillution.  We used about 20 mg for 1 mL for the extraction. So, to get µg/mg should just have to divide by the sample amount (about 20mg). 

To get µg/mg tea leaf

```{r}
sample_ammount_2017 <-
  read_csv(here("data", "raw", "2017QData - Sheet1.csv")) %>%
  clean_names() %>% 
  select(sample, mg_tea)

sample_ammount_2018 <- 
  read_csv(here('data', 'raw', '2018 total polyphenols.csv')) %>% 
  clean_names() %>% 
  select(sample, mg_tea)

sample_ammount <- bind_rows(sample_ammount_2017, sample_ammount_2018)
```

```{r}
lcms_tidy <-
  full_join(lcms_tidy, sample_ammount) %>% 
  mutate(conc_ug_mg = conc/mg_tea)
```


# Add in treatment and leaf damage data

```{r}
leaf_damage_2017 <-
  read_rds(here('data', 'cleaned', '2017_treatment_data.rds'))

leaf_damage_2018 <-
  read_rds(here('data', 'cleaned', '2018_treatment_data.rds'))

leaf_damage <- bind_rows(leaf_damage_2017, leaf_damage_2018)

lcms_complete <- left_join(lcms_tidy, leaf_damage) #only keep damage data for plants that I have LCMS data for.
```


Ok, now I need to do a few more things:

- deal with non-detects
    + could use 1/IS (paraxanthine), but I'm not sure that makes sense
    + could use 0
    + could use 1/small number.  E.g. smallest concentration detected in whole dataset.
- separate 2017 and 2018 data
- Spread so each compound is a column to get wide data for stats



# Split 2017 and 2018

These should be analyzed separately since methods were different.  That's why I'm splitting them in the wrangling step.

```{r}
lcms_2017 <- 
  lcms_complete %>% 
  filter(str_detect(sample, "Q"))

lcms_2018 <-
  lcms_complete %>% 
  filter(!str_detect(sample, "Q"))
```



# Create wide versions

```{r}
lcms_2017_wide <- lcms_2017 %>% 
  select(-conc, -mg_tea) %>% #keep only the ug/mg concentration
  spread(key = compound, value = conc_ug_mg)

lcms_2018_wide <- lcms_2018 %>% 
  select(-conc, -mg_tea) %>% 
  spread(key = compound, value = conc_ug_mg)
```





# Write data to rds

```{r}
write_rds(lcms_2017, here("data", "cleaned", "2017_lcms_tidy.rds"))
write_rds(lcms_2017_wide, here("data", "cleaned", "2017_lcms_wide.rds"))
write_rds(lcms_2018, here("data", "cleaned", "2018_lcms_tidy.rds"))
write_rds(lcms_2018_wide, here("data", "cleaned", "2018_lcms_wide.rds"))
```

