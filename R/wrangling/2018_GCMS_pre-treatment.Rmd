---
title: "2018 GCMS pre-treatment"
author: Eric R. Scott
date: "2019-07-31"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
    highlight: kate
    theme: yeti
---
```{r setup}
knitr::opts_chunk$set(
	echo = TRUE
)
```
*Last compiled: `r Sys.Date()`*
# Packages

```{r}
library(tidyverse)
library(chemhelper)
library(here)
```

# Read in Data
## All the exported integration files

Need to be connected to network drive for this to work!

```{r}
Data.dir <- "/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data"
if(!dir.exists(Data.dir)) {
  stop("Gotta connect to the network drive!")
}
files <- dir(Data.dir,
             pattern = "Shengzhou_adj Integration Report.csv",
             full.names = TRUE, #adds full path
             recursive = TRUE) #drills down in directory structure

filenames <- str_extract(files, "(?<=/)[^/]+(?=/[^/]+$)")
# samples <- str_extract(filenames, "(?<=Hop_).+(?=\\.D)")
gc_tidy <- files %>%
  map(read_IA) %>%
  set_names(filenames) %>% 
  bind_rows(.id = "filename") %>% 
  rename(area = `Area [a.u.*s]`,
         rt = `R.Time [min.]`)
gc_tidy
```

## Alkane files
Read and wrangle
```{r}
alkanes1 <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data/073018_alkanemix/Meth_073018_alkanemix Integration Report.csv")
alkanes_lj <-
  alkanes1 %>% 
  slice(1:19) %>%  #that's enough I think.
  mutate(rt = ifelse(`R.Time [min.]` == 0, `Expect. [min.]`, `R.Time [min.]`)) %>% 
  select(Compound, rt) %>% 
  add_column(C_num = 6:24)


alkanes2 <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data/082018_Alkane/Meth_073018_alkanemix Integration Report.csv")
alkanes_jgy <- 
  alkanes2 %>% 
  slice(1:19) %>% 
  mutate(rt = ifelse(`R.Time [min.]` == 0, `Expect. [min.]`, `R.Time [min.]`)) %>% 
  select(Compound, rt) %>% 
  add_column(C_num = 6:24)
```

## Extract cultivar and sample name from filename
I think jinguanyin blank20 is actually not a blank

```{r}
gc_tidy <-
  gc_tidy %>% 
  mutate(filename = str_remove(filename, ".D$")) %>% # for some reason one file has a .D at the end.
  mutate(filename = str_replace(filename, "Blank20", "Bag20")) %>% #pretty sure it's not a blank
  mutate(cultivar = case_when(str_detect(filename, "Longjing") ~ "L",
                              str_detect(filename, "Jin") ~ "J",
                              TRUE ~ as.character(NA)), #shouldn't be any NAs, but just in case
         plant_num = as.character(as.integer(str_extract(filename, "\\d+$"))), #blanks will be NA
         sample = paste0(cultivar, plant_num)) %>% 
  select(filename, cultivar, plant_num, sample, everything())
```


# Tag non-detects and to-be-censored

```{r}
gc_tidy <-
  gc_tidy %>%
  mutate(ND = area == 0,
         Censor = area > 0 & area < 1000)
```


# Remove known contaminants and problematic peaks
Contaminants:

- Propanoic acid, 2-methyl-, 1-(1, 1-dimethylethyl)-2methyl-1, 3-propanediyl ester (from nitrile gloves)
- Toluene (very large peak, seems unlikely that it is a natural product)

These chlorinated compounds are likely pesticides:

- Benzaldehyde, 2,6-dichloro-
- Benzene, chloro-

```{r}
contaminants <- c("Propanoic acid, 2-methyl-, 1-(1,1-dimethylethyl)-2-methyl-1,3-propanediyl ester",
                  "Toluene",
                  "Benzyl chloride",
                  "Benzene, chloro-",
                  "Benzaldehyde, 2,6-dichloro-",
                  "141")

# gc_tidy %>% filter(Compound %in% contaminants) %>% count(filename)
gc_tidy.1 <-
  gc_tidy %>%
  filter(!Compound %in% contaminants) %>%
  filter(No. > 91)
```

# Calculate RPA

```{r}
#extract napthalene D8 area
gc_IS <-
  gc_tidy.1 %>% 
  filter(Compound == "Naphthalene-D8") %>%
  rename(IS = area) %>% 
  select(filename, IS)

#join with gc.tidy and mutate to calculate RPA
gc_tidy.2 <- full_join(gc_tidy.1, gc_IS)
gc_tidy.2 <- gc_tidy.2 %>% 
  mutate(RPA = area/IS) %>% 
  #don't need Naphtalene-D8 anymore
  filter(Compound != "Naphthalene-D8")
# gc_tidy.2 %>% filter(str_detect(filename, "Jin")) %>% count(filename)
```

# Method blank subtraction

I have two method blanks, one for each cultivar

```{r}
gc_tidy.3 <- 
  gc_tidy.2 %>% 
  #split by cultivar
  group_by(cultivar) %>% 
  group_split() %>% 
  # for each cultivar extract the blanks and join them to the data minus the blanks
  purrr::map(~{
    blank <- filter(., str_detect(filename, "[b,B]lank")) %>% 
      rename(background = RPA) %>% 
      select(Compound, background)
    gc <- filter(., !str_detect(filename, "[b,B]lank"))
    left_join(gc, blank)
  }) %>% 
  # recombine cultivars
  bind_rows()
```

Two ways of dealing with blanks:

1. Literal subtraction
2. Nicole's method: if RPA > background then keep it as is, if RPA <= background, set to zero.
```{r}
gc_tidy.4 <- gc_tidy.3 %>% 
  mutate(RPA = RPA-background)
gc_tidy.4
```


# Remove rare peaks
Should this be done before or after blank subtraction?
Remove compounds that are found in 3 or fewer samples.

```{r}
gc_tidy.5 <-
  gc_tidy.4 %>% 
  group_by(Compound) %>% #for each compound...
  filter(sum(RPA > 0) >= 3) #calculate the number of rows where RPA > 0 then filter the dataframe to keep only those where that sum is greater than or equal to 3

# gc_tidy.4 %>% count(filename) #536 compounds
# gc_tidy.5 %>% ungroup() %>% count(filename) #359 compounds
```

# Read in leafhopper density and damage data and join

```{r}
treatments <- read_rds(here('data', 'cleaned', '2018_treatment_data.rds'))
gc_tidy.6 <- left_join(gc_tidy.5, treatments)
```

# Calculate Retention Indices

```{r}
gc_tidy.7 <-
  gc_tidy.6 %>% 
  mutate(ri = case_when(cultivar == "J" ~ calc_RI(rt, alkanes_jgy$rt, alkanes_jgy$C_num),
                        cultivar == "L" ~ calc_RI(rt, alkanes_lj$rt, alkanes_lj$C_num)))
```

# Add CAS numbers
TODO

# Deal with non-detects, censored peaks, and other zeros and negative values

Nondetects were zeros to begin with, not found by IonAnalytics at all.  Censored peaks are those with peak area < 1000.  According to the Robbat lab, areas < 1000 are not accurate due to being below the LOD.  There are multiple options for dealing with this, but they usually set those peaks to zero.  There may be other RPA values <= 0 due to subtracting the method blank.

I'll set all zeroes to 1/IS.  This will be useful for log-transforming data since log(0) = -inf. I also add a "present" column that will be useful for getting compound counts and such later on.


```{r}
gc_tidy.final <-
  gc_tidy.7 %>%
  mutate(RPA = case_when(ND      ~ 1/IS,
                         Censor  ~ 1/IS,
                         RPA <=0 ~ 1/IS,
                         TRUE    ~ RPA),
         present = case_when(ND      ~ FALSE,
                             Censor  ~ FALSE,
                             RPA <=0 ~ FALSE,
                             TRUE    ~ TRUE)) %>%
  select(sample, cultivar, density_start, density_end, mean_percent_damage, twister_damage, No., Compound, RPA, rt, ri, present)

#How many compounds detected in each sample?
gc_tidy.final %>%
  group_by(sample) %>%
  summarize(num_compounds = sum(present))
```


# Create wide dataframe for multivariate analysis


Unfortunately changes column order to alphabetical.  This is fixed in `tidyr` 1.0 with the `pivot_wider()` function, but I don't think its so important that I need to use a development version of a package.

```{r}
gc_wide <- 
  gc_tidy.final %>%
  select(-rt, -ri, -No., -present) %>%
  spread(key = Compound, value = RPA)
```


# Write to file

I think all I'm going to need is the tidy version with the `present` column and the wide version.  I can do any data transformations in the analysis script.

```{r}
write_rds(gc_tidy.final, here('data', 'cleaned', '2018_gcms_tidy.rds'))
write_rds(gc_wide, here('data', 'cleaned', '2018_gcms_wide.rds'))
```




