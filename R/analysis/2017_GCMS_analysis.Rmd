---
title: "2017 Leafhopper GCMS analysis"
author: "Eric R. Scott"
date: "2019-08-01"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999) #turn off scientific notation
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(readxl)
#for RDA:
library(vegan)
library(RVAideMemoire)
#for figures:
library(cowplot)
```

# Purpose

What is the goal of this notebook?

# Load Data
Read in cleaned GCMS data (which includes leafhopper density already) and leafhopper damage data (from image analysis)

```{r data, echo=TRUE}
gc_wide <- read_rds(here("data", "cleaned", "2017_gcms_wide.rds"))
gc_tidy <- read_rds(here("data", "cleaned", "2017_gcms_tidy.rds"))
gc_wide.zeroes <- read_rds(here("data", "cleaned", "2017_gcms_zeroes.rds"))
```

```{r}
annotations <- read_excel(here("data", "cleaned", "Compound annotation updated.xlsx")) %>% rename(compound = Compound)
```


## Data Dictionary

`gc_tidy`: A tidy dataframe of all the chemistry and other data

- `sample`: Sample name
- `cultivar`: In this year, all plants were Qing Xin Da Mao, but I included this column for uniformity with the 2018 experiment.
- `density_start`: The density of leafhoppers applied at the start of the experiment in **insects/young leaf**
- `density_end`: Ending density in **insects/young leaf** 
- `mean_percent_damage`: Percentage of damaged pixels averaged across all leaves for that sample
- `twister_damage`: Percentage of damaged pixels for the leaf the volatiles were sampled from.
- `No.`: Compound number.  This comes from the Ion Analytics methods file.
- `Compound`: Compound name
- `RPA`: Relative peak area
- `rt`: retention time, in minutes
- `ri`: retention index
- `present`: logical. Was the compound detected in a particular sample?

`gc_wide`: A wide version with columns for each `Compound` with `RPA` as the value


# Data pre-treatment
Most data pre-treatment was done in the wrangling Rmd. I already determine that log transformation followed by scaling is probably a good idea to improve normality.  However, the data is still zero-inflated, so it might be better to just use a distance based approach instead, which I think is "nonparametric".  Maybe it doesnt' really matter though since the permuation test for the RDA is nonparametric anyway.

```{r}
#attribute stripper function
rm_attr <- function(x){
  attributes(x) <- NULL
  return(x)
  }

#columns that aren't compound RPAs
metavars <- c("sample", "cultivar", "density_start", "density_end", "mean_percent_damage", "twister_damage")
```
 

```{r}
gc_wide.logscale <- 
  gc_wide %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>%
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)

gc_wide.zeroes <- 
  gc_wide.zeroes %>% 
  mutate_at(vars(-metavars), scale) %>% 
  mutate_at(vars(-metavars), rm_attr)

#set up chemistry data for RDA
chemdata <- gc_wide.logscale %>% select(-metavars) %>% as.data.frame()
rownames(chemdata) <- gc_wide.logscale$sample
```

I may also want to log-transform the percent leaf damage data, but I can do that ad-hoc later.

```{r}
ggplot(gc_wide.logscale, aes(log(mean_percent_damage))) + geom_histogram(bins = 7)
```


# Analysis

## Descriptive statistics
1. how many compounds total?
94
```{r}
gc_tidy %>% group_by(sample) %>% tally()
```

2. how many compounds are found in all samples?
Only 4
```{r}
gc_tidy %>% 
  group_by(Compound) %>% 
  summarize(nsample = sum(present)) %>% 
  filter(nsample > 18) %>% 
  rename(compound = Compound) %>%
  left_join(annotations)

```


## RDA for density
### Fit RDA model

Only analysis for the regular RDA is shown, because the distance-based RDA gave the same results and you can't get loadings from it.

```{r}
#scaled, transformed
rda_dens <-
  rda(chemdata ~ gc_wide.logscale$density_end)
```

### How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dens)
```

yeesh, only 9.12% explained by ending density
29.24% using the distance-based model with untransformed data.  BUT, I think this is wrong.

### ANOVA
3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dens)
```

Significant effect of ending density on leaf volatiles


### Loadings / Correlations

I need to extract loadings, then figure out which compounds are signifcantly correlated with RDA axis, **not** with leafhopper density.  Should be correlation of scores with data.

```{r}
dens_scores <-
  scores(rda_dens, display = "sites", scaling = 0) %>% 
  as_tibble(rownames = "sample")

dens_loads <- scores(rda_dens, display = "species", scaling = 0) %>% 
  as_tibble(rownames = "compound")
```

1. Correlation between data and RDA axis

```{r}
dens_corr <-
  map_df(chemdata,
         ~cor.test(.x, dens_scores$RDA1) %>%
           broom::glance(),
         .id = "compound") %>% 
  select(compound, correlation = estimate, corr.p.value = p.value)
```

2. Univariate linear models

```{r}
dens_lm <- 
  map_df(chemdata, ~{
    m <- lm(.x ~ gc_wide.logscale$density_end)
    broom::tidy(m) %>%
      filter(term != "(Intercept)") %>%
      select(-term) %>% 
      mutate(lm.AIC = broom::glance(m)$AIC)
  },
  .id = "compound") %>% 
  select(compound, slope = estimate, lm.p.value = p.value, lm.AIC)
```

3. Step function

```{r}
stepfinder <- function(x, y, pts = NULL){

  pts <- seq(min({{x}}), max({{x}}), length.out = 100)
  lmlist <- map(pts, ~lm({{y}} ~ I({{x}}<=.) + I({{x}} > .)))
  bestone <- lmlist %>% map_dbl(~AIC(.)) %>% which.min()
  df <- tibble(#step.model = lmlist[bestone],
               breakpoint = pts[bestone],
               AIC = stats::AIC(lmlist[[bestone]]))
  return(df)
}

dens_step <-
  map_df(chemdata,
         ~stepfinder(gc_wide.logscale$density_end, ., pts = seq(0.3, 0.7, length.out = 50)),
         .id = "compound")

dens_step %>%
  rename(step.AIC = AIC) %>%
  full_join(dens_corr) %>% 
  full_join(dens_lm) %>% 
  mutate(stepped = step.AIC < lm.AIC - 2) %>% 
  filter(corr.p.value <= 0.05 | lm.p.value <= 0.05) %>% 
  arrange(desc(abs(correlation))) 
```
Hmm... seems like too many things work as step-functions, even when I restrict the range of breakpoints.

3. Join with loadings

```{r}
dens_load_tbl <- 
  full_join(dens_loads, dens_corr, by = "compound") %>%
  full_join(dens_lm, by = "compound")
```

4. Save this one for supplemental

5. Filter by either significant correlation to RDA or significant univariate regression. Arrange by absolute value of correlation coefficient.

```{r}
dens_biomarkers <-
  dens_load_tbl %>% 
  filter(corr.p.value <= 0.05 | lm.p.value <= 0.05) %>% 
  arrange(desc(abs(correlation))) %>% 
  select(-PC1)
dens_biomarkers
```

6. Plot all 20 for supplemental

```{r}
#TODO
```

## RDA for damage
### Fit RDA

```{r}
rda_dam <- rda(chemdata ~ gc_wide.logscale$twister_damage)
```

### How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dam)
```
Twister leaf damage explains 8% of variation in loged scaled volatiles. 
8.33% if I use a distance-based RDA

### ANOVA
3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dam)
```
Marginally significant


### Loadings / Correlations

Setup pieces:
```{r}
dam_scores <- scores(rda_dam, display = "sites", scaling = 0) %>% as_tibble(rownames = "sample")
dam_loads <- scores(rda_dam, display = "species", scaling = 0) %>% as_tibble(rownames = "compound")
```

1. Correlation with RDA axis

```{r}
dam_corr <-
  map_df(chemdata,
         ~cor.test(.x, dam_scores$RDA1) %>% 
           broom::glance(),
         .id = "compound") %>% 
  select(compound, correlation = estimate, corr.p.value = p.value)
```

2. Univariate linear models

```{r}
dam_lm <-
  map_df(chemdata,
         ~lm(.x ~ gc_wide.logscale$twister_damage) %>% 
           broom::tidy(), 
         .id = "compound") %>%
  filter(term != "(Intercept)") %>% 
  select(compound, slope = estimate, lm.p.value = p.value)
```

3. Join with loadings

```{r}
dam_load_tbl <- full_join(dam_loads, dam_corr, by = "compound") %>% full_join(dam_lm, by = "compound")
```

4. Save this one for supplemental

5. Filter by either significant correlation to RDA or significant univariate regression. Arrange by absolute value of correlation coefficient.

```{r}
dam_biomarkers <-
  dam_load_tbl %>% 
  filter(corr.p.value <= 0.05 | lm.p.value <= 0.05) %>% 
  arrange(desc(abs(correlation))) %>% 
  select(-PC1)
dam_biomarkers
```


# Biomarker Table
Join data from both response variables

```{r}
dens_biomarkers <- left_join(dens_biomarkers, annotations)
dam_biomarkers <- left_join(dam_biomarkers, annotations)
biomarker_tab <-
  bind_rows(
  dens_biomarkers %>% add_column(response = "Density"),
  dam_biomarkers %>% add_column(response = "Damage")
) %>% 
  mutate_all(~na_if(.,"NA")) %>% #replace text NAs with actual NAs
  mutate(`Chemical Family` = snakecase::to_sentence_case(`Chemical Family`)) %>% 
  # mutate_at(vars(loading, p.adj), round, 3) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  mutate(Compound = ifelse(is.na(`Pretty Name`), compound, `Pretty Name`)) %>% 
  select(Compound,
         CAS,
         "RDA axis loading" = RDA1,
         "Correlation to RDA axis" = correlation,
         "Correlation p-value" = corr.p.value,
         "Slope" = slope,
         "Linear model p-value" = lm.p.value,
         Aroma,
         `Chemical Family`,
         "Herbivory proxy" = response)
biomarker_tab
```

write to CSV for formatting in Numbers / Excel

```{r}
write_excel_csv(biomarker_tab, here("figs", "2017 biomarkers.csv"), na = "-")
```

## Univariate plots

```{r}
# dens_data <- gc_tidy %>% filter(Compound %in% pull(dens_biomarkers, compound))

dens_data <-
  left_join(dens_biomarkers, gc_tidy) %>% 
  mutate(`Pretty Name` = fct_reorder(`Pretty Name`, abs(loading), .desc = TRUE))


dens_plot <-
  ggplot(dens_data, aes(x = density_end, y = RPA)) +
  geom_point() +
  facet_wrap(~`Pretty Name`, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Leafhopper density (insects / young leaf)",
       y = "Relative peak area")
dens_plot
```

```{r}
save_plot(here("figs", "density-biomarkers.png"), dens_plot,
          ncol = 4,
          nrow = 4, 
          base_height = 2,
          base_asp = 1.3)
```


## Univariate plots

Here, I should plot these biomarkers and look for thresholds/non-linear patterns.

```{r}
dam_data <-
  left_join(dam_biomarkers, gc_tidy) %>% 
  mutate(`Pretty Name` = fct_reorder(`Pretty Name`, abs(loading), .desc = TRUE))

dam_plot <-
  ggplot(dam_data, aes(x = twister_damage, y = RPA)) +
  geom_point() +
  facet_wrap(~`Pretty Name`, scale = "free_y") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "% Damage to DCSE focal leaf",
       y = "Relative peak area")
dam_plot
```

```{r}
save_plot(here("figs", "damage-biomarkers.png"), dam_plot,
          ncol = 3,
          nrow = 2,
          base_height = 2,
          base_asp = 1.3)
```
