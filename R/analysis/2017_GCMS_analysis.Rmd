---
title: "2017 Leafhopper GCMS analysis"
author: "Eric R. Scott"
date: "2019-08-01"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
#for RDA:
library(vegan)
library(RVAideMemoire)

library(ropls)
library(chemhelper) #for get_VIP
# library(cowplot)
# library(latex2exp)
# library(webchem)
```

# Purpose

What is the goal of this notebook?

# Load Data
Read in cleaned GCMS data (which includes leafhopper density already) and leafhopper damage data (from image analysis)
```{r data, echo=TRUE}
gc_wide <- read_rds(here("data", "cleaned", "2017_gcms_wide.rds"))
gc_tidy <- read_rds(here("data", "cleaned", "2017_gcms_tidy.rds"))
gc_wide
```

## Data Dictionary

`gc_tidy`: A tidy dataframe of all the chemistry and other data

- `sample`: Sample name
- `cultivar`: In this year, all plants were Qing Xin Da Mao, but I included this column for uniformity with the 2018 experiment.
- `density_start`: The density of leafhoppers applied at the start of the experiment in **insects/young leaf**
- `density_end`: Ending density in **insects/young leaf** 
- `mean_percent_damage`: Percentage of damaged pixels averaged across all leaves for that sample
- `twister_damage`: Percentage of damaged pixels for the leaf the volatiles were sampled from.
- `No.`: Compound number.  This comes from the Ion Analytics methods file.
- `Compound`: Compound name
- `RPA`: Relative peak area
- `rt`: retention time, in minutes
- `ri`: retention index
- `present`: logical. Was the compound detected in a particular sample?

`gc_wide`: A wide version with columns for each `Compound` with `RPA` as the value


# Data pre-treatment

```{r}
#attribute stripper function
rm_attr <- function(x){
  attributes(x) <- NULL
  return(x)
  }

metavars <- c("sample", "cultivar", "density_start", "density_end", "mean_percent_damage", "twister_damage")
```
 
I already determined in the pre-treatment Rmd that log transformation followed by scaling is probably a good idea to improve normality.  However, the data is still zero-inflated, so it might be better to just use a distance based approach instead, which I think is "nonparametric".  Maybe it doesnt' really matter though since the permuation test for the RDA is nonparametric anyway.

```{r}
gc_wide.logscale <- 
  gc_wide %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>%
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr) #%>%
  # filter(sample != "Q2") #not going to remove from GC analysis

gc_wide.log <-
  gc_wide %>% 
  mutate_at(vars(-metavars), log)
```


# Analysis

```{r}
ggplot(gc_wide.logscale, aes(log(mean_percent_damage)))+ geom_histogram(bins = 10)
```
I might want to log-transofrm the percent damage data.

## RDA for density
1. Fit RDA model

```{r}
#scaled, transformed
rda_dens <-
  rda(gc_wide.logscale %>% select(-metavars) ~ density_end,
      data = gc_wide.logscale)

#logged only??
rda_dens2 <-
  rda(gc_wide.log %>% select(-metavars) ~ density_end,
      data = gc_wide.log)

#distance based on unscaled, untransformed data. Probs not worth it since you can't get loadings
dbrda_dens <-
  dbrda(gc_wide %>% select(-metavars) ~ density_end,
      data = gc_wide.logscale)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dens)
```


yeesh, only 9.12% explained by ending density

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dens)
```

Significant effect of ending density on leaf volatiles

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda_dens)
```

5. Loadings

Ending density model:

```{r}
dens_loads <-
  rda_dens$CCA$v %>% 
  as_tibble(rownames = "Compound") %>% 
  arrange(desc(abs(RDA1)))

dens_cors <-
  gc_tidy %>% 
  group_by(Compound) %>% 
  group_modify(~cor.test(~density_end + log(RPA), data = .x) %>% broom::glance(), keep = TRUE) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr")) %>% 
  select(Compound, estimate, p.value, p.adj)

full_join(dens_loads, dens_cors) %>% 
  arrange(desc(abs(RDA1))) %>% 
  filter(p.adj < 0.05)
```

Looks like similar to VIP scores from PLSR (below).  Compounds from density make a lot more sense.  Ugh...Do I just ignore the whole leaf image analysis stuff?


## RDA for damage
1. Fit RDA

```{r}
rda_dam <- 
  rda(gc_wide.logscale %>% select(-metavars) ~ twister_damage,
      data = gc_wide.logscale)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dam)
```
Twister leaf damage explains 8% of variation in loged scaled volatiles

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dam)
```
Marginally significant

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda_dam)
```

5. Loadings

```{r}
td_loads <- 
  rda_dam$CCA$v %>% 
  as_tibble(rownames = "Compound") %>% 
  arrange(desc(abs(RDA1)))

td_cors <-
  gc_tidy %>% 
  group_by(Compound) %>% 
  group_modify(~cor.test(~twister_damage + log(RPA), data = .x) %>% broom::glance(), keep = TRUE) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr")) %>% 
  select(Compound, estimate, p.value, p.adj)

full_join(td_loads, td_cors) %>% 
  arrange(desc(abs(RDA1))) %>% 
  filter(p.adj < 0.05)
```









## PLS-R by density_end


```{r}
plsr_end <- opls(select(gc_wide.log, -metavars), gc_wide.log$density_end,
             scaleC = "standard",
             # predI = 1,
             # orthoI = NA,
             permI = 200,
             plotL = FALSE)
# plot(plsr_end, parLabVc = gc_wide.log$sample)
```

RMSEE = 0.176 for log-transformed data and 0.2 for untransformed

## PLS-R by mean damage

(not run, not significant. doesn't matter if transformed or not.)

```{r eval=FALSE, include=FALSE}
plsr_md <- opls(select(gc_wide.log, -metavars),
                log(gc_wide.log$mean_percent_damage),
             scaleC = "standard",
             # predI = 1,
             # orthoI = NA,
             plotL = FALSE)
# plot(plsr_md, parLabVc = gc_wide.log$sample)
```

## PLS-R by damage to twister leaf

```{r}
# plsr_td <- opls(select(gc_wide.log, -metavars),
#                 gc_wide.log$twister_damage,
#              scaleC = "standard",
#              # predI = 1,
#              # orthoI = NA,
#              plotL = FALSE)
# plot(plsr_td, parLabVc = gc_wide.log$sample)

plsr_td_log <- opls(select(gc_wide.log, -metavars),
                log(gc_wide.log$twister_damage),
             scaleC = "standard",
             # predI = 1,
             # orthoI = NA,
             permI = 200,
             plotL = FALSE)
# plot(plsr_td_log, parLabVc = gc_wide.log$sample)
```

PLS by twister leaf damage is the best model (highest R2Y and Q2Y and lowest RMSEE).  I'll use that for future analyses. 

## Extract VIP

```{r}
VIP_dens <-
  get_VIP(plsr_end) %>%
  arrange(desc(VIP)) %>%
  rename(Compound = "Variable")
VIP_dens

VIP_dam <- 
  get_VIP(plsr_td) %>%
  arrange(desc(VIP)) %>%
  rename(Compound = "Variable")
VIP_dam
```

Different set of compounds associated with leaf damage than with leafhopper density. Hmmmmmmmmm

## Get correlation coefs with density

figured out with help from [stack overflow](https://goo.gl/9hacZe)

```{r message=FALSE, warning=FALSE}
correlations <- 
  gc_tidy %>% 
  select(-sample, -rt) %>%
  nest(-Compound) %>%
  mutate(cor.test = map(data,
                        ~cor.test(.$density_end, log(.$RPA), method = "spearman") %>%
                          broom::glance(.))) %>% 
  unnest(cor.test) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr")) %>% 
  select(Compound, estimate, p.value, p.adj)

VIPtable_dens <- left_join(VIP_dens, correlations) %>% filter(VIP > 1)
VIPtable_dens
```
```{r message=FALSE, warning=FALSE}
correlations <- 
  gc_tidy %>% 
  select(-sample, -rt) %>%
  nest(-Compound) %>%
  mutate(cor.test = map(data,
                        ~cor.test(.$twister_damage, log(.$RPA), method = "spearman") %>%
                          broom::glance(.))) %>% 
  unnest(cor.test) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr")) %>% 
  select(Compound, estimate, p.value, p.adj)

VIPtable_dam <- left_join(VIP_dam, correlations) %>% filter(VIP > 1)
VIPtable_dam
```


### Summarise VIP results

How many VIPs are positive correlations?  How many negative?

```{r}
VIPtable_dam %>%
  summarise(num.pos = sum(estimate > 0),
            num.neg = sum(estimate < 0))
```

How many high VIPs also significant univariate (log) correlations?

```{r}
VIPtable_strict <-
  VIPtable_dam %>%
  filter(p.adj <= 0.1)

VIPtable_strict

VIPtable_strict %>%
  summarise(num.pos = sum(estimate > 0),
            num.neg = sum(estimate < 0))
```

## Check out univariate plots for VIPs

```{r}
plsdata.tidy <-
  plsdata %>% 
  gather(-sample, -density_start, -density_end, -damage_mean.percent, -damage_T,
         key = Compound, value = logRPA)
#For ones with significant correlations also
plsdata.tidy %>%
  filter(Compound %in% VIPtable_strict$Compound)

d <-
  left_join(VIPtable_strict %>% filter(VIP > 2), plsdata.tidy) %>% 
  mutate(Compound = fct_inorder(Compound)) %>% 
  mutate(Compound = case_when(str_detect(Compound, "Farnesene")      ~ "(E,E)-alpha-Farnesene",
                              str_detect(Compound, "Hepten-")        ~ "6-methyl-5-Hepten-2-one",
                              str_detect(Compound, "Linalool oxide") ~ "dehydroxy-trans-Linalool oxide",
                              str_detect(Compound, "Bergamot")       ~ "trans-alpha-Bergamotene",
                              str_detect(Compound, "Hexenyl")        ~ "(Z)-3-hexenyl hexenoate",
                              str_detect(Compound, "Ocimene\\<allo-\\>")  ~ "allo-Ocimene",
                              str_detect(Compound, "Ocimene\\<\\(E\\)-beta-\\>") ~ "(E)-beta-Ocimene",
                              TRUE ~ as.character(Compound)))
```
```{r density-end-plot}
colors <- c(
  "(E,E)-alpha-Farnesene" = "#F57670",
  "6-methyl-5-Hepten-2-one" = "#A3A420",
  "trans-alpha-Bergamotene" = "#925211",
  "Myrcene" = "#92130B",
  "dehydroxy-trans-Linalool oxide" = "#1EBD7F"
  )

univariate <-
  ggplot(d, aes(x = density_end, y = logRPA)) +
  geom_point(aes(color = Compound)) +
  # geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x,2)) +
  # geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~fct_reorder(Compound, logRPA, mean, .desc = TRUE), scales = "free_y") +
  labs(x = "Leafhopper Density (insects/shoot)",
       y = "log(Relative peak area)") +
  theme_grey() +
  theme(rect = element_rect("black"),
        text = element_text(color = "white"),
        axis.text = element_text(color = "white"),
        axis.ticks = element_line(color = "white"),
        legend.position = "none") +
  scale_color_manual(values = colors)

univariate
```

```{r}
save_plot(here("figs", "density-end-plot.png"),
          univariate,
          nrow = 2, ncol = 3,
          base_width = 2.5,
          base_height = 2.5)
```

## Flavor percepts for VIPs

I'm going with these top 6 VIPs that have VIP > 1 but also have a significant p-value from a correlation.

```{r}
method <-
  read_IA(here("Method File Construction", "BACE_MS-Subtraction Compound References.csv")) %>%
  select(Compound, CAS)
VIPtable <- 
  left_join(VIPtable %>% filter(VIP>2), method)
VIPtable <- VIPtable %>% 
  mutate(percept = fn_percept(as.cas(CAS))) %>% 
  #manually insert flavor percepts for dehydroxy linalool oxide from FooDB.ca
  mutate(percept = ifelse(CAS == "54750708", "green, herbal, minty, phenolic, rosemary, spice", percept))
VIPtable
```

## Better plots

```{r}
#extract plot data
pcaplotdata <-
  pca.5 %>%
  get_plotdata()
#annotate with leafhopper density
pcaplotdata$scores <-
  pcaplotdata$scores %>%
  add_column(density = plsdata$density_end)

#generate plot
p <-
  ggplot(pcaplotdata$scores, aes(x = p1, y = p2, color = density)) +
  geom_point(size = 3) +
  labs(x = paste0("PC1 (", round(pcaplotdata$axis_stats$R2X[1]*100, 2), "%)"),
       y = paste0("PC2 (", round(pcaplotdata$axis_stats$R2X[2]*100, 2), "%)")) +
  scale_color_gradient("Leafhopper Density\n(number / shoot)", low = "blue", high = "red") +
  theme_bw() +
  ggtitle("PCA with density labeled",
          subtitle = TeX(paste("$R^2(cum) = ",
                               last(pcaplotdata$axis_stats$`R2X(cum)`),
                               "$ with ",
                               length(pcaplotdata$axis_stats$`R2X(cum)`),
                               " components")))
p
```

```{r}
plsplotdata <-
  plsr_end %>%
  get_plotdata()

p2 <-
  ggplot(plsplotdata$scores, aes(x = p1, y = o1, color = y1)) +
  geom_point(size = 3) +
  labs(x = paste0("Predictive (", round(plsplotdata$axis_stats[1,1]*100, 2), "%)"),
       y = paste0("Orthogonal (", round(plsplotdata$axis_stats[2,1]*100, 2), "%)")) +
  scale_color_gradient("Leafhopper Density\n(number / shoot)", low = "blue", high = "red") +
  ggtitle("OPLS", subtitle = TeX(paste0("$R^2_Y = ", plsplotdata$model_stats$`R2Y(cum)`,
                                        "$; $Q^2 = ", plsplotdata$model_stats$`Q2(cum)`,
                                        "$; $p_{Q^2} = ", plsplotdata$model_stats$pQ2))) +
  theme_grey() +
  theme(rect = element_rect("black"),
        text = element_text(color = "white"),
        axis.text = element_text(color = "white"),
        axis.ticks = element_line(color = "white"))
p2
```

```{r}
save_plot(here("figs", "PLSR plot talk.png"), p2, base_aspect_ratio = 1.4)
```

```{r}
legend <- get_legend(p)
p.out <- 
  plot_grid(p + theme(legend.position = "none"),
            p2 + theme_bw() + theme(legend.position = "none"),
            legend,
            ncol = 3, nrow = 1, rel_widths = c(1,1,0.5))

save_plot(here("figs", "prelim PCA.png"), p.out, ncol = 2, nrow = 1, base_aspect_ratio = 1.1)
```

# Write Data
```{r}
plsdata %>% 
  write_rds(here("cleaned_data", "leafhopper pls data.rds"))
```

