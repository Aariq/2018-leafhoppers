---
title: "2018 Leafhopper GCMS analysis"
author: "Eric R. Scott"
date: "2019-08-01"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
#for RDA:
library(vegan)
library(RVAideMemoire)
```

# Purpose

What is the goal of this notebook?

# Load Data
Read in cleaned GCMS data (which includes leafhopper density already) and leafhopper damage data (from image analysis)
```{r data, echo=TRUE}
gc_wide <- read_rds(here("data", "cleaned", "2018_gcms_wide.rds"))
gc_tidy <- read_rds(here("data", "cleaned", "2018_gcms_tidy.rds"))
gc_wide
```

## Data Dictionary

`gc_tidy`: A tidy dataframe of all the chemistry and other data

- `sample`: Sample name
- `cultivar`: Either J (Jin Guan Yin) or L (Long Jing #43)
- `density_start`: The density of leafhoppers applied at the start of the experiment in **insects/shoot**
- `density_end`: Ending density in **insects/shoot** 
- `mean_percent_damage`: Percentage of damaged pixels averaged across all leaves for that sample
- `twister_damage`: Percentage of damaged pixels for the leaf the volatiles were sampled from. Many values are missing because I forgot to mark which leaf had the Twister on it.
- `No.`: Compound number.  This comes from the Ion Analytics methods file.
- `Compound`: Compound name
- `RPA`: Relative peak area
- `rt`: retention time, in minutes
- `ri`: retention index
- `present`: logical. Was the compound detected in a particular sample?

`gc_wide`: A wide version with columns for each `Compound` with `RPA` as the value


# Data pre-treatment
I'm going to log-transform and scale the wide data

```{r}
#attribute stripper function
rm_attr <- function(x){
  attributes(x) <- NULL
  return(x)
  }

metavars <- c("sample", "cultivar", "density_start", "density_end", "mean_percent_damage", "twister_damage")

gc_wide.log <- 
  gc_wide %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr) %>% 
  filter(sample != "J23")
```

Should I remove J23?  This was the plant that had a large amount of damage for the # of leafhoppers.  Probably should be consistent across analyses. Like:

"One sample (plant J23) was removed due to a large amount of damage for the leafhopper density.  In addition to that, two other samples (plants J4 and J11) was removed from the GCMS dataset due to being an outlier as detected by hdoutliers"

# Analysis

```{r}
ggplot(gc_wide.log, aes(log(mean_percent_damage)))+ geom_histogram(bins = 10)
```
I might want to log-transofrm the percent damage data.

## RDA
1. Fit RDA model

```{r}
#using ending density
rda_dens <- 
  rda(gc_wide.log %>% select(-metavars) ~ density_end*cultivar,
      data = gc_wide.log)

#using mean percent damage
rda_dam <- 
  rda(gc_wide.log %>% select(-metavars) ~ log(mean_percent_damage)*cultivar,
      data = gc_wide.log)

#using twister leaf
gc_wide.t <- gc_wide.log %>% filter(!is.na(twister_damage))
rda_t <-
  rda(gc_wide.t %>% select(-metavars) ~ log(twister_damage)*cultivar,
      data = gc_wide.t)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dens)
MVA.synt(rda_dam)
MVA.synt(rda_t)
```
Density*cultivar explains 34.77% of variation
Damage*cultivar explains 34.89% of variation
Twister leaf damage*cultivar explains 32.04% of variation (less data here)

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dam)
anova(rda_dens)
anova(rda_t)
```

all are highly significant

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda_dam)
MVA.anova(rda_dens)
MVA.anova(rda_t)
```

Yup, only effect of cultivar `r emo::ji("sob")`

