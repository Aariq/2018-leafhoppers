---
title: "2018 Leafhopper GCMS analysis"
author: "Eric R. Scott"
date: "2019-08-01"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(readxl)
#for RDA:
library(vegan)
library(RVAideMemoire)
#for figures:
library(cowplot)
#for step and hinge models
library(chngpt)
```

# Purpose

This is the main analysis of volatile data for the paper. Multivariate analysis with redundancy analysis (RDA).  I decided to go with RDA over PLSR because I like that it gives me the percentage of variation explained by the predictor variables (herbivory proxies) whereas PLSR just gives a R2 for the axis (how much variation in X and Y does the *axis* explain).  I then identify biomarkers as compounds with significant correlations to the first (only) RDA axis, and do some univariate tests on them to see if they best fit a null (intercept only), line, step function, or hinge and then plot the results and produce a table.

# Load Data
Read in cleaned GCMS data (which includes leafhopper density already) and leafhopper damage data (from image analysis)
```{r data, echo=TRUE}
gc_wide <- read_rds(here("data", "cleaned", "2018_gcms_wide.rds"))
gc_tidy <- read_rds(here("data", "cleaned", "2018_gcms_tidy.rds"))
# gc_wide.zeroes <- read_rds(here("data", "cleaned", "2018_gcms_zeroes.rds"))
```

## Data Dictionary

`gc_tidy`: A tidy dataframe of all the chemistry and other data

- `sample`: Sample name
- `cultivar`: Either J (Jin Guan Yin) or L (Long Jing #43)
- `density_start`: The density of leafhoppers applied at the start of the experiment in **insects/shoot**
- `density_end`: Ending density in **insects/shoot** 
- `mean_percent_damage`: Percentage of damaged pixels averaged across all leaves for that sample
- `twister_damage`: Percentage of damaged pixels for the leaf the volatiles were sampled from. Many values are missing because I forgot to mark which leaf had the Twister on it.
- `No.`: Compound number.  This comes from the Ion Analytics methods file.
- `Compound`: Compound name
- `RPA`: Relative peak area
- `rt`: retention time, in minutes
- `ri`: retention index
- `present`: logical. Was the compound detected in a particular sample?

`gc_wide`: A wide version with columns for each `Compound` with `RPA` as the value

# Load Functions
Custom functions needed for analysis:

```{r}
#attribute stripper function
rm_attr <- function(x){
  attributes(x) <- NULL
  return(x)
}

#Model chooser
#note, this ONLY works when models are in order null, line, step, hinge
bestAIC <- function(AIC){
  if(any(AIC[1] >= AIC[2:4] + 2)){
    if(any(AIC[2] >= AIC[3:4] + 2)){
      return(min(AIC[3:4]))
    } else {
      return(AIC[2])
    }
  } else {
    return(AIC[1])
  }
}


#Custom tidier for chngpt models. Turns output into dataframe.  Warning: this is not very reusable code.
tidy.chngpt <- function(chngpt.mod) {
  df <- bind_cols(
    chngpt.mod$coefficients[1:2] %>% t() %>% as_tibble(),
    summary(chngpt.mod)$chngpt %>%  set_names(c("chngpt", "chngpt.lower.CI", "chngpt.upper.CI")) %>% t() %>% as_tibble()
  )
  return(df)
}
```

# Data pre-treatment
I'm going to log-transform and scale the wide data

```{r}
metavars <- c("sample", "cultivar", "density_start", "density_end", "mean_percent_damage", "twister_damage")
```
 
```{r}
gc_wide.logscale <- 
  gc_wide %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)

gc_wide.zeroes <-
  gc_wide.zeroes %>% 
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)
```

```{r}
ggplot(gc_wide.logscale, aes(log(mean_percent_damage)))+ geom_histogram(bins = 10)
```
I might want to log-transofrm the percent damage data.



# Analysis
# Descriptive statistics
1. How many compounds?
```{r}
gc_tidy %>% group_by(sample) %>% tally()
```
2. How many in Long Jing, how many in JGY?
```{r}
gc_tidy %>%
  filter(cultivar == "J") %>% 
  group_by(Compound) %>% #for each compound...
  filter(sum(present) > 0) %>% group_by(sample) %>% tally()

gc_tidy %>% 
  filter(cultivar == "L") %>% 
  group_by(Compound) %>% 
  filter(sum(present) > 0) %>%
  group_by(sample) %>% tally()
```

3. How many found in **all** JGY or **all** LJ samples?
```{r}
gc_tidy %>% 
  filter(cultivar == "J") %>% #count() #22 samples total
  summarize(nsamp = sum(present)) %>% 
  filter(nsamp == 20)

gc_tidy %>% 
  filter(cultivar == "L") %>% #count() #19 samples total
  summarize(nsamp = sum(present)) %>% 
  filter(nsamp == 19)
```


## RDA for density
1. Fit RDA model

```{r}
#using ending density
rda_dens <- 
  rda(gc_wide.logscale %>% select(-metavars) ~ density_end*cultivar,
      data = gc_wide.logscale)
#distance based on unscaled, untransformed data.
dbrda_dens <-
  dbrda(gc_wide.zeroes %>% select(-metavars) ~ density_end,
      data = gc_wide.zeroes)
```
 
```{r}
#using mean percent damage
rda_dam <- 
  rda(gc_wide.logscale %>% select(-metavars) ~ (mean_percent_damage)*cultivar,
      data = gc_wide.logscale)

#using twister leaf
gc_wide.t <- gc_wide.logscale %>% filter(!is.na(twister_damage))
rda_t <-
  rda(gc_wide.t %>% select(-metavars) ~ (twister_damage)*cultivar,
      data = gc_wide.t)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda_dens)
MVA.synt(rda_dam)
MVA.synt(rda_t)
```
Density*cultivar explains 75.97% of variation
Damage*cultivar explains 76.37% of variation
Twister leaf damage*cultivar explains 71.73% of variation (less data here)

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda_dam)
anova(rda_dens)
anova(rda_t)
```

all are highly significant

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda_dam)
MVA.anova(rda_dens)
MVA.anova(rda_t)
```

Yup, only effect of cultivar `r emo::ji("sob")`

```{r}
rda_cultivar <- rda(gc_wide.logscale %>% select(-metavars) ~ cultivar,
      data = gc_wide.logscale)
MVA.synt(rda_cultivar)
anova(rda_cultivar)
MVA.anova(rda_cultivar)
```

```{r}
loads <- MVA.load(rda_cultivar)$loads %>% rename(loading = `Constr. comp. 1`)

MVA.plot(rda_cultivar, fac = gc_wide.logscale$cultivar)

```

positive loading means greater concentration in J. negative loading means greater concentration in L.

# Splitting by cultivar

I don't really believe that ALL compounds were in higher concentration in one cultivar.  Seems like differences in sampling/running on GCMS.  Let's split the cultivars and run separate RDAs.

I need to split them *before* scaling!

```{r}
gc_jgy <-   
  gc_wide %>% 
  filter(cultivar == "J") %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)
gc_jgy.t <-   
  gc_wide %>% 
  filter(cultivar == "J") %>% 
  filter(!is.na(twister_damage)) %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)
gc_lj <- 
  gc_wide %>% 
  filter(cultivar == "L") %>% 
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)

gc_lj.t <- 
  gc_wide %>% 
  filter(cultivar == "L") %>% 
  filter(!is.na(twister_damage)) %>%
  mutate_at(vars(-metavars), log) %>%
  mutate_at(vars(-metavars), scale) %>% 
  #strip atrributes left by scale() that interfere with some other functions down the road
  mutate_at(vars(-metavars), rm_attr)
```

```{r}
rda_jgy_dens <- 
  rda(gc_jgy %>% select(-metavars) ~ density_end,
      data = gc_jgy)
anova(rda_jgy_dens)

rda_jgy_dam <-
  rda(gc_jgy %>% select(-metavars) ~ mean_percent_damage,
      data = gc_jgy)
anova(rda_jgy_dam)

rda_jgy_t <- 
  rda(gc_jgy.t %>% select(-metavars) ~ twister_damage,
      data = gc_jgy.t)
anova(rda_jgy_t)
```

```{r}
rda_lj_dens <-
  rda(gc_lj %>% select(-metavars) ~ density_end,
      data = gc_lj)
anova(rda_lj_dens)

rda_lj_dam <-
  rda(gc_lj %>% select(-metavars) ~ mean_percent_damage,
      data = gc_lj)
anova(rda_lj_dam)

rda_lj_t <-
  rda(gc_lj.t %>% select(-metavars) ~ mean_percent_damage,
      data = gc_lj.t)
anova(rda_lj_t)
```


