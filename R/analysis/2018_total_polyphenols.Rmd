---
title: "2018 Total Polyphenols"
output: 
  html_notebook: 
    toc: yes
    toc_float: yes
---


Total polyphenols were measured by Amma Agyei using the Folin-Ciocalteau assay Spring of 2019.

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(here)
library(car)
library(janitor)
library(cowplot)
library(broom)
library(glue)
library(gghighlight)
library(knitr)
```

# Read in data

Total polyphenols data, leafhopper density data, and leaf damage data

```{r message=FALSE, warning=FALSE}
tp <- read_csv(here("data", "raw", "2018 total polyphenols.csv"))
damage <- read_rds(here('data', 'cleaned', '2018_treatment_data.rds'))
```

Join data sheets.

```{r}
tp2 <- 
  tp %>% 
  clean_names() %>% 
  full_join(damage, by = "sample") %>%
  select(-leaf_density) #identical to `density_end`
tp2
```

- sample: cultivar and sample ID. Q = qing xin da mao
- standard_deviation: from averaging triplicates
- mean_ga_equivalent: galic acid equivalents in mg/mL (i think)
- coefficient_of_variation: from averaging triplicates(?)
- leaf_density: leafhopper density at end of experiment in insects/young leaf
- mg_tea: mg of tea powder
- mg_g_gae: galic acid equivalents in mg/g of tea powder


These data are means of triplicate runs.

# Regression with leafhopper density as predictor

Data seem normal enough to use a regular linear model

```{r}
shapiro.test(tp2$mg_g_gae)
#normal enough
```
I'll test for a quadratic or linear relationship

```{r}
dens.poly.cv <- lm(mg_g_gae ~ poly(density_end, 2)*cultivar, data = tp2)
dens.poly <- lm(mg_g_gae ~ poly(density_end, 2), data = tp2)
dens.linear.cv <- lm(mg_g_gae ~ density_end*cultivar, data = tp2)
dens.linear <- lm(mg_g_gae ~ density_end, data = tp2)
dens.cv <- lm(mg_g_gae ~ cultivar, data = tp2)
dens.null <- lm(mg_g_gae ~ 1, data = tp2)
AIC(dens.poly.cv, dens.poly, dens.linear.cv, dens.linear, dens.cv, dens.null)
lmtest::lrtest(dens.linear.cv)
```

The null model wins. No effect of cultivar or leafhopper density on total polyphenols.

# Relationship between density and damage

Let's check the relationship between leafhopper density and damage

```{r echo=FALSE}
ggplot(tp2, aes(x = density_end, y = mean_percent_damage, color = cultivar)) +
  geom_point() +
  gghighlight(mean_percent_damage > 7, use_direct_label = TRUE, label_key = sample) +
  labs(x = "Final leafhopper density (insects / shoot)",
       y = "Mean % damaged leaf area") +
  theme_bw()
```

J23 has really high damage. It has 3 completely dead leaves, which maybe should be excluded.

For example:
```{r}
include_graphics(here("docs", "leaf 31.png"))
```

# Regression with %damage as predictor

```{r}
dam.poly.cv <- lm(mg_g_gae ~ poly(mean_percent_damage, 2)*cultivar, data = tp2)
dam.poly <- lm(mg_g_gae ~ poly(mean_percent_damage, 2), data = tp2)
dam.linear.cv <- lm(mg_g_gae ~ mean_percent_damage*cultivar, data = tp2)
dam.linear <- lm(mg_g_gae ~ mean_percent_damage, data = tp2)
dam.cv <- lm(mg_g_gae ~ cultivar, data = tp2)
dam.null <- lm(mg_g_gae ~ 1, data = tp2)
AIC(dam.poly.cv, dam.poly, dam.linear.cv, dam.linear, dam.cv, dam.null)

Anova(dam.linear)
```

Now the model without cultivar is the best fit and shows a moderate linear relationship between damage and total polyphenols.

## Polyphenols vs. Damage

```{r echo=FALSE}
p2 <-
  ggplot(tp2, aes(x = mean_percent_damage, y = mg_g_gae)) +
  geom_point() +
  gghighlight(mean_percent_damage > 7, label_key = sample, use_direct_label = TRUE) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  labs(x = "Mean % damaged leaf area",
       y = "Total polyphenols (mg/g GAE)") +
  theme_bw() +
  annotate(geom = "text", x = 1.1, y = 4, label = glue("p = {round(Anova(dam.linear)$`Pr(>F)`[1], 3)}"))
p2
```

J23 is an obvious outlier.  Without it:

## If I remove sample J23...

```{r}
tp3 <- tp2 %>% filter(sample != "J23")
dam.poly.cv <- lm(mg_g_gae ~ poly(mean_percent_damage, 2)*cultivar, data = tp3)
dam.poly <- lm(mg_g_gae ~ poly(mean_percent_damage, 2), data = tp3)
dam.linear.cv <- lm(mg_g_gae ~ mean_percent_damage*cultivar, data = tp3)
dam.linear <- lm(mg_g_gae ~ mean_percent_damage, data = tp3)
dam.cv <- lm(mg_g_gae ~ cultivar, data = tp3)
dam.null <- lm(mg_g_gae ~ 1, data = tp3)
AIC(dam.poly.cv, dam.poly, dam.linear.cv, dam.linear, dam.cv, dam.null)

Anova(dam.linear)
```

Now the null model is best and there is no longer an effect of % damage.

```{r}
p3 <-
  ggplot(tp3, aes(x = mean_percent_damage, y = mg_g_gae)) +
  geom_point() +
  # gghighlight(mean_percent_damage > 7, label_key = sample, use_direct_label = TRUE) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  labs(x = "Mean % damaged leaf area",
       y = "Total polyphenols (mg/g GAE)") +
  theme_bw() +
  annotate(geom = "text", x = 1.1, y = 4, label = glue("p = {round(Anova(dam.linear)$`Pr(>F)`[1], 3)}"))
p3
```



