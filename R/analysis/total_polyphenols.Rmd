---
title: "2017 Total Polyphenols"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
    toc_float: yes
    highlight: kate
    theme: yeti
---

Total polyphenols were measured by Amma Agyei using the Folin-Ciocalteau assay Spring of 2019.

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(here)
library(car)
library(janitor)
library(cowplot)
library(broom)
library(glue)
library(gghighlight)
library(knitr)
library(ggrepel)
```

# Read in data

Total polyphenols data, leafhopper density data, and leaf damage data

```{r message=FALSE, warning=FALSE}
tp2017 <- read_csv(here("data", "raw", "2017 total polyphenols.csv"))
damage2017 <- read_rds(here('data', 'cleaned', '2017_treatment_data.rds'))

tp2018 <- read_csv(here("data", "raw", "2018 total polyphenols.csv"))
damage2018 <- read_rds(here('data', 'cleaned', '2018_treatment_data.rds'))
```

Join data sheets.

```{r}
tp2017 <- 
  tp2017 %>% 
  clean_names() %>% 
  full_join(damage2017, by = "sample") %>%
  select(-leaf_density) #identical to `density_end`
tp2017
```
```{r}
tp2018 <- 
  tp2018 %>% 
  clean_names() %>% 
  full_join(damage2018, by = "sample") %>%
  select(-leaf_density) #identical to `density_end`
tp2018
```


- `sample`: cultivar and sample ID. Q = qing xin da mao
- `standard_deviation`: from averaging triplicates
- `mean_ga_equivalent`: galic acid equivalents in mg/mL (i think)
- `coefficient_of_variation`: from averaging triplicates(?)
- `leaf_density`: leafhopper density at end of experiment in insects/young leaf
- `mg_tea`: mg of tea powder
- `mg_g_gae`: galic acid equivalents in mg/g of tea powder


These data are means of triplicate runs.

# 2017

Total polyphenol data seem normal enough to use a regular linear model

```{r}
shapiro.test(tp2017$mg_g_gae)
#normal enough
```

## Relationship between density and damage

Let's check the relationship between leafhopper density and damage

```{r echo=FALSE}
dens_dam_2017 <-
  ggplot(tp2017, aes(x = density_end, y = mean_percent_damage, label = sample)) +
  geom_point() +
  geom_text_repel(data = tp2017 %>% filter(mean_percent_damage > 10)) +
  labs(x = "Final leafhopper density (insects / young leaf)",
       y = "Mean % damaged leaf area",
       subtitle = "2017") +
  theme_bw()

dens_dam_2017 
tp2017 %>% filter(sample == "Q2")
```

Q2 stands out as extreme.  Inspection of the images shows that it includes 3 leaves with heavy hopperburn.

For example:

```{r echo=FALSE}
include_graphics(here::here("docs", "plant_2_leaf_6.png"))
```

Even without this sample, there is clearly not a perfectly linear relationship between leafhopper density and damage.  Using damage as a predictor might give different results and would also allow me to potentially combine data from multiple years (although I did use a different classifier for the two years...I *could* re-do image analysis using the same classifier, or possibly re-train one on samples from both years.)

## Remove sample Q2

```{r}
tp2017 <- tp2017 %>% filter(sample != "Q2")

#re-make plot

dens_dam_2017 <-
  ggplot(tp2017, aes(x = density_end, y = mean_percent_damage, label = sample)) +
  geom_point() +
  # geom_text_repel(data = tp2017 %>% filter(mean_percent_damage > 10)) +
  labs(x = "Final leafhopper density (insects / young leaf)",
       y = "Mean % damaged leaf area",
       subtitle = "2017") +
  theme_bw()
```

## Polyphenols vs. Density

I'll test for a quadratic or linear relationship.  **NOTE**: I could possibly do this by using # leafhoppers as a predictor and # leaves as an offset.  Not sure if that would be any different though.

```{r}
dens.poly.17 <- lm(mg_g_gae ~ poly(density_end, 2), data = tp2017)
dens.linear.17 <- lm(mg_g_gae ~ density_end, data = tp2017)
dens.null.17 <- lm(mg_g_gae ~ 1, data = tp2017)
bbmle::AICtab(dens.poly.17, dens.linear.17, dens.null.17)
# summary(dens.poly.17)
Anova(dens.poly.17)
```

Looks like best model is intercept only, although polynomial is maybe better than linear.  No significant relationship between leafhopper density and total phenolics, with a trend toward a polynomial relationship.

```{r eval=FALSE, include=FALSE}
ggplot(augment(dens.poly.17), aes(.resid)) + geom_histogram(bins = 15)
ggplot(augment(dens.poly.17), aes(sample = .resid)) + geom_qq() + geom_qq_line()
```

```{r echo=FALSE}
dens.2017.plot <-
  ggplot(tp2017, aes(x = density_end, y = mg_g_gae)) +
  geom_point() +
  # geom_smooth(method = "lm", formula = "y ~ poly(x, 2)", se = FALSE) +
  labs(x = "Final leahopper density (insects / young leaf)",
       y = "Total polyphenols (mg/g GAE)",
       # caption = "Sample Q2 removed",
       title = "2017") +
  theme_bw() 
dens.2017.plot
```

## Polyphenols vs. Damage

```{r}
dam.poly.17 <- lm(mg_g_gae ~ poly(mean_percent_damage, 2), data = tp2017)
dam.linear.17 <- lm(mg_g_gae ~ mean_percent_damage, data = tp2017)
dam.null.17 <- lm(mg_g_gae ~ 1, data = tp2017)
bbmle::AICtab(dam.poly.17, dam.linear.17, dam.null.17)
Anova(dam.poly.17)
```
Now, the polynomial model is the best and there is a marginally significant relationship with  % damage (p = `r round(Anova(dam.poly.17)[["Pr(>F)"]][1],3)`)


```{r echo=FALSE}
dam.2017.plot <-
  ggplot(tp2017, aes(x = mean_percent_damage, y = mg_g_gae)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ poly(x, 2)", se = FALSE) +
  labs(x = "Mean % damaged leaf area",
       y = "Total polyphenols (mg/g GAE)",
       # caption = "Sample Q2 removed",
       title = "2017") +
  theme_bw() +
  annotate(geom = "text", x = 1.1, y = 3, label = glue("p = {round(Anova(dam.poly.17)$`Pr(>F)`[1], 3)}"))
dam.2017.plot
```


# 2018


## Regression with leafhopper density as predictor

Data seem normal enough to use a regular linear model

```{r}
shapiro.test(tp2018$mg_g_gae)
#normal enough
```

## Relationship between density and damage

Let's check the relationship between leafhopper density and damage

```{r echo=FALSE}
dens_dam_2018 <-
  ggplot(tp2018, aes(x = density_end, y = mean_percent_damage, color = cultivar, label = sample)) +
  geom_point() +
  geom_text_repel(data = tp2018 %>% filter(mean_percent_damage > 7)) +
  labs(x = "Final leafhopper density (insects / shoot)",
       y = "Mean % damaged leaf area",
       subtitle = "2018") +
  scale_color_discrete(name = "Cultivar", labels = c("J" = "JGY", "L" = "LJ")) +
  theme_bw()

dens_dam_2018
tp2018 %>% filter(sample == "J23")
```

J23 has really high damage. It has 3 completely dead leaves, which maybe should be excluded.

For example:
```{r}
include_graphics(here("docs", "leaf 31.png"))
```

## Remove sample J23

```{r}
tp2018 <- tp2018 %>% filter(sample != "J23")

#re-create plot
dens_dam_2018 <-
  ggplot(tp2018, aes(x = density_end, y = mean_percent_damage, color = cultivar, label = sample)) +
  geom_point() +
  # geom_text_repel(data = tp2018 %>% filter(mean_percent_damage > 7)) +
  labs(x = "Final leafhopper density (insects / shoot)",
       y = "Mean % damaged leaf area",
       subtitle = "2018") +
  scale_color_discrete(name = "Cultivar", labels = c("J" = "JGY", "L" = "LJ")) +
  theme_bw()
```

## Split cultivars
I've decided it's gonna be best to just analyze the two cultivars separately for everything
```{r}
tp_jgy <- tp2018 %>% filter(str_detect(sample, "J"))
tp_lj <- tp2018 %>% filter(str_detect(sample, "L"))
```

## Polyphenols vs. density

I'll test for a quadratic or linear relationship

### Jin Guan Yin
```{r}
dens.jgy.poly <- lm(mg_g_gae ~ poly(density_end, 2), data = tp_jgy)
dens.jgy.lm <- lm(mg_g_gae ~ density_end, data = tp_jgy)
dens.jgy.null <- lm(mg_g_gae ~ 1, data = tp_jgy)
bbmle::AICtab(dens.jgy.poly, dens.jgy.lm, dens.jgy.null)
```

The null model wins. No effect of leafhopper density on total polyphenols for JGY

### Long Jing

```{r}
dens.lj.poly <- lm(mg_g_gae ~ poly(density_end, 2), data = tp_lj)
dens.lj.lm <- lm(mg_g_gae ~ density_end, data = tp_lj)
dens.lj.null <- lm(mg_g_gae ~ 1, data = tp_lj)
bbmle::AICtab(dens.lj.poly, dens.lj.lm, dens.lj.null)
# car::Anova(dens.lj.lm)
```

The null model wins. No effect of leafhopper density on total polyphenols for JGY



```{r}
dens.2018.plot <-
  ggplot(tp2018, aes(x = density_end, y = mg_g_gae, color = cultivar)) +
  geom_point() +
  labs(x = "Final leafhopper density (insects / shoot)",
       y = "Total polyphenols (mg/g GAE)",
       title = "2018") +
  scale_color_discrete(name = "Cultivar", labels = c("J" = "JGY", "L" = "LJ")) +
  theme_bw() 
dens.2018.plot
```

## Polyphenols vs. damage
### Jin Guan Yin
```{r}
dam.jgy.poly <- lm(mg_g_gae ~ poly(mean_percent_damage, 2), data = tp_jgy)
dam.jgy.lm <- lm(mg_g_gae ~ mean_percent_damage, data = tp_jgy)
dam.jgy.null <- lm(mg_g_gae ~ 1, data = tp_jgy)
bbmle::AICtab(dam.jgy.poly, dam.jgy.lm, dam.jgy.null)
```
Null model wins

### Long Jing
```{r}
dam.lj.poly <- lm(mg_g_gae ~ poly(mean_percent_damage, 2), data = tp_lj)
dam.lj.lm <- lm(mg_g_gae ~ mean_percent_damage, data = tp_lj)
dam.lj.null <- lm(mg_g_gae ~ 1, data = tp_lj)
bbmle::AICtab(dam.lj.poly, dam.lj.lm, dam.lj.null)
```

The winning model is the null model

```{r}
dam.2018.plot <-
  ggplot(tp2018, aes(x = mean_percent_damage, y = mg_g_gae, color = cultivar)) +
  geom_point() +
  labs(x = "Mean % damaged leaf area",
       y = "Total polyphenols (mg/g GAE)",
       title = "2018") +
  scale_color_discrete(name = "Cultivar", labels = c("J" = "JGY", "L" = "LJ")) +
  theme_bw() 
dam.2018.plot
```

# Figures

## Density vs. damage
For both years, so two panel figure
Add panel with leaf images.

First, figure out what low, medium, and high damage are.

```{r}
tp2017 %>% summarize(low = min(mean_percent_damage), max = max(mean_percent_damage), mid = median(mean_percent_damage))
#low = 0.566, mid = 1.883, high = 11.583
rawdamage2017 <- read_rds(here('data', 'cleaned', '2017_leaf_damage_new.rds'))
rawdamage2017 %>%
  filter(near(percent_damage, 10, tol = 0.01))
rawdamage2017 %>% arrange(desc(percent_damage))
```

Representative leaves:

- low: Q11 leaf 1, 0.56 % damage
- mid: Q9 leaf 3, 1.87% damage
- high: Q18 leaf 3, 12.68% damage (hopperburn)
- high: Q13 leaf 7, 8.71% damage 

```{r}
library(magick)
low <- image_read(here::here("img", "low-damage.png")) %>%
  image_scale("x600") %>% 
  image_annotate("0.56%", size = 30, location = "+10+10")
mid<- image_read(here("img", "mid-damage.png")) %>%
  image_scale("x600") %>% 
  image_annotate("1.87%", size = 30, location = "+10+10")
high <- image_read(here("img", "high-damage.png")) %>%
  image_scale("x600") %>% 
  image_annotate("8.71%", size = 30, location = "+10+10")

leaf_examples <-
  image_append(c(low, mid, high)) %>%
  image_border("white", "50x50") %>% 
  rasterGrob()

```

```{r}
dens_vs_dam <-
  plot_grid(dens_dam_2017 + coord_cartesian(ylim = c(0, 12)),
            dens_dam_2018 + coord_cartesian(ylim = c(0,12)) +
              theme(legend.position = "none"), labels = c("B", "C")) %>% 
  plot_grid(get_legend(dens_dam_2018), rel_widths = c(1, 0.1))

dens_dam_full <-
  plot_grid(leaf_examples, dens_vs_dam,
          ncol = 1,
          labels = "A",
          rel_heights = c(0.75, 1))

# dens_vs_dam
save_plot(here('figs', 'dam_dens_img.png'), dens_dam_full, ncol = 2, nrow = 2, base_asp = 1.1)
```

## Density/damage vs. polyphenols
for both years, so 4 panel plot


```{r}
dam_dens_tp <-
  plot_grid(dam.2017.plot + 
              # ylab(NULL) +
              ylim(3,9),
            dam.2018.plot +
              # ylab(NULL) +
              ylim(3,9) +
              theme(legend.position = "none"),
            dens.2017.plot +
              labs(title = NULL) +
              # ylab(NULL) +
              ylim(2,9),
            dens.2018.plot +
              labs(title = NULL) +
              # ylab(NULL) +
              ylim(2,9) +
              theme(legend.position = "none"), 
            labels = "AUTO") %>% 
  plot_grid(get_legend(dam.2018.plot), rel_widths = c(1, 0.1))

dam_dens_tp
save_plot(here('figs', 'tp.png'), dam_dens_tp, ncol = 2, nrow = 2)
```




