---
title: "LCMS analysis"
author: "Eric R. Scott"
date: "2019-07-26"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(ropls)
library(chemhelper)
library(naniar)
library(visdat)
library(broom)
library(modelr)
library(glue)
```

# Purpose

Analysis of LCMS data from 2017 and 2018 leafhopper density experiments.

# Load Data

```{r data, echo=TRUE}
lc2017 <- read_rds(here("data", "cleaned", "2017_lcms_wide.rds")) %>% 
  filter(sample != "Q2") #determined elsewhere that this has an unusually high ammount of damage for the treatment
lc2018 <- read_rds(here("data", "cleaned", "2018_lcms_wide.rds"))

lc2017_tidy <-
  read_rds(here('data', 'cleaned', '2017_lcms_tidy.rds')) %>% 
  filter(sample != "Q2")
```

## Data Dictionary

`lc2017` and `lc2018`: Wide versions of LCMS data for both years with compounds as columns.

- `sample`: sample name
- `cultivar`: Q = Qing Xin Da Mao, L = Long Jing, J = Jin Guan Yin
- `plant_num`: another identifier, extracted from sample name
- `mean_leaf_area_px`: mean leaf area in pixels
- `mean_percent_damage`: mean percent area damaged
- `n_leaves`: number of leaves scanned and ground into powder for this analysis
- `twister_damage`: percent damage on the twister leaf.  Ignore for LCMS analysis.
- `density_treatmetn`: categorical.  This was the leafhopper density I aimed to treat the plants with in insects/young leaf for 2017 and insects/shoot in 2018
- `density_start`, `density_end`: The density of leafhoppers at the start and end of the experiments.  In insects/young leaf in 2017 and insects/shoot in 2018
- The rest of the columns are concentrations of compounds in **µg/mg** leaf

# Analysis
## Deal with NAs

NAs are non-detects.  I should replace them with 0 or a very small number.

```{r}
vis_dat(lc2017)
```


```{r}
lc2017_2 <-
  lc2017 %>% 
  mutate_all(~ifelse(is.na(.), 0.0001, .)) %>% 
  select(-`Catechin gallate`) #all zeroes

lc2017_tidy <- 
  lc2017_tidy %>% 
  filter(compound != "Catechin gallate") %>% #not detected in any sample
  mutate(conc_ug_mg = ifelse(is.na(conc_ug_mg), 0.0001, conc_ug_mg))
```

## Examine correlations

```{r}
corrr::correlate(lc2017_2[11:23]) %>% 
  corrr::shave() %>% 
  corrr::rplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

There are some strong correlations, so multivariable methods might be best?

## 2017 PCA

```{r}
X <- lc2017_2[11:23]

opls(X, printL = FALSE)
```

## 2017 PLSR

No significant relationship between density or damage and metabolites. High R2Y, but very low Q2.  Overfitting?  Maybe if I remove some of the metabolites with a LOT of NAs?

```{r}
try(opls(X, lc2017_2$density_end))
opls(X, lc2017_2$mean_percent_damage, permI = 500, plotL = FALSE, printL = FALSE)
```



## Regression analysis

Ok, new approach.  Let's just do linear regressions?  Best way would be to load in the **tidy** versions of the data, do the same filtering (remove Q2, etc.), and then use tidyverse magic do all the regressions.

```{r}
lc2017_2

caf <- lm(Caffeine ~ mean_percent_damage, data = lc2017_2)
null <- lm(Caffeine ~ 1, data = lc2017_2)
summary(caf)
car::Anova(caf)

c <- lm(Catechin ~ mean_percent_damage, data = lc2017_2)
car::Anova(c)


```
```{r}


results <-
  lc2017_tidy %>% 
  select(sample, compound, conc_ug_mg, mean_percent_damage, density_end) %>% 
  group_by(compound) %>% 
  nest() %>% #creates list column of data for each compound
  mutate(lm = map(data, ~lm(conc_ug_mg ~ mean_percent_damage, .))) %>%  # apply a linear model
  mutate(poly = map(data, ~lm(conc_ug_mg ~ poly(mean_percent_damage, 2), .))) %>%  # apply a polynomial model
  mutate(null = map(data, ~lm(conc_ug_mg ~ 1, .))) %>% # apply a null model
  select(compound, data, lm, poly, null) %>% 
  gather(-compound, -data, key = model.type, value = model) %>% 
  mutate(stats = map(model, glance)) %>%
  unnest(stats) %>% 
  arrange(compound, AIC) %>% 
  # filter(p.value < 0.2) %>%
  select(compound, model.type, AIC, p.value, everything())
  

# #this also works
# results <- lc2017_tidy %>% 
#   group_by(compound) %>%
#   do(tidy(lm(conc_ug_mg ~ mean_percent_damage, .))) %>% 
#   ungroup() %>% 
#   mutate(p.adj.fdr = p.adjust(p.value, "fdr")) #%>% 
#   # filter(term == "mean_percent_damage", p.adj.fdr < 0.2)
results
```

Looks like EGCG has a pretty strong significant negative relationship with damage.  Makes sense as EGCG would be converted into theaflavins and other polymerized compounds.

- Caffeine: linear, **p = 0.05**
- Catechin: polynomial, p = 0.09
- Epicatechin: polynomial, p = 0.16
- Epicatechin gallate: linear, p = 0.096
- Epigallocatechin: null
- Epigallocatechin gallate: linear, **p = 0.0003**
- Gallic acid: null
- Gallocatechin: null
- Gallocatechin gallate: linear, p = 0.086
- L-theanine: null
- Paraxanthine: null
- Theobromine: linear, **p = 0.05**
- Theophylline: null
```{r}
results2 <- results %>% 
  filter(compound == "Caffeine" & model.type == "lm" |
         compound == "Catechin" & model.type == "poly" |
         compound == "Epicatechin" & model.type == "poly" |
         compound == "Epicatechin gallate" & model.type == "lm" |
         compound == "Epigallocatechin gallate" & model.type == "lm" |
         compound == "Gallocatechin gallate" & model.type == "lm" |
         compound == "Theobromine" & model.type == "lm")
```

```{r}
lc2017_tidy %>% 
  filter(compound %in% results$compound) %>% 
  ggplot(aes(x = mean_percent_damage, y = conc_ug_mg, color = compound)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~compound, scales = "free_y") +
  theme(legend.position = "none") +
  labs(x = "Mean % damaged leaf area",
       y = "Concentration (µg/mg)")
```

This should actually be a multi-panel plot with the correct line (quadratic or linear) based on the best-fit model.  Should annotate with p-values.

```{r}
#Augment results with predicted values for drawing curves/lines
results2 <-
  results2 %>%
  mutate(pred = map2(model, data, ~{
    ndf <- tibble(mean_percent_damage = seq(min(.y$mean_percent_damage),
                                            max(.y$mean_percent_damage),
                                            length.out = 50))
    augment(.x, newdata = ndf)
    }))

# map a plotting function to every compound
pmap(list(.x = results2$data, .y = results2$pred, .name = results2$compound, .p = results2$p.value), 
     function(.x, .y, .name, .p) {
       ggplot(.x, aes(x = mean_percent_damage, y = conc_ug_mg)) +
         geom_point() +
         geom_line(aes(x = mean_percent_damage, y = .fitted), data = .y) +
         labs(x = "Mean % damaged leaf area",
              y = "Concentration (µg/mg)",
              subtitle = .name,
              caption = glue("p = {round(.p, 4)}")) +
         theme_bw()
     })
```


