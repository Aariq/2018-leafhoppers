---
title: "LCMS analysis"
author: "Eric R. Scott"
date: "2019-07-26"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen =999) #turn off scientific notation
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(lubridate)
library(here)
library(vegan)
library(RVAideMemoire)
library(chemhelper)
library(naniar)
library(visdat)
library(broom)
library(modelr)
library(glue)
library(cowplot)

here <- here::here #make sure to override the here() function from lubridate
```

# Purpose

Analysis of LCMS data from 2017 and 2018 leafhopper density experiments.

# Load Data

```{r data, echo=TRUE}
lc2017 <- read_rds(here("data", "cleaned", "2017_lcms_wide.rds")) %>% 
  filter(sample != "Q2") #determined elsewhere that this has an unusually high ammount of damage for the treatment
lc2018 <- read_rds(here("data", "cleaned", "2018_lcms_wide.rds")) %>% 
  filter(sample != "J23") #determined elswhere that this has an unusually high ammount of damage for the treatment

lc2017_tidy <-
  read_rds(here('data', 'cleaned', '2017_lcms_tidy.rds')) %>% 
  filter(sample != "Q2")

lc2018_tidy <- 
  read_rds(here('data', 'cleaned', '2018_lcms_tidy.rds')) %>% 
  filter(sample != "J23")
```

## Data Dictionary

`lc2017` and `lc2018`: Wide versions of LCMS data for both years with compounds as columns.

- `sample`: sample name
- `cultivar`: Q = Qing Xin Da Mao, L = Long Jing, J = Jin Guan Yin
- `plant_num`: another identifier, extracted from sample name
- `mean_leaf_area_px`: mean leaf area in pixels
- `mean_percent_damage`: mean percent area damaged
- `n_leaves`: number of leaves scanned and ground into powder for this analysis
- `twister_damage`: percent damage on the twister leaf.  Ignore for LCMS analysis.
- `density_treatmetn`: categorical.  This was the leafhopper density I aimed to treat the plants with in insects/young leaf for 2017 and insects/shoot in 2018
- `density_start`, `density_end`: The density of leafhoppers at the start and end of the experiments.  In insects/young leaf in 2017 and insects/shoot in 2018
- The rest of the columns are concentrations of compounds in **µg/mg** leaf

# Analysis
## Deal with NAs

NAs are non-detects.  I should replace them with 0 or a very small number.

```{r}
vis_dat(lc2017)
vis_dat(lc2018)
```


```{r}
# min(lc2017_tidy$conc_ug_mg, na.rm = TRUE)

lc2017_tidy <- 
  lc2017_tidy %>% 
  filter(compound != "Catechin gallate") %>% #not detected in any sample
  mutate(conc_ug_mg = ifelse(is.na(conc_ug_mg), 0.0001, conc_ug_mg))

lc2017_2 <-
  lc2017 %>% 
  mutate_all(~ifelse(is.na(.), 0.0001, .)) %>% 
  select(-`Catechin gallate`) #all zeroes

# min(lc2018_tidy$conc_ug_mg, na.rm = TRUE)
lc2018_tidy <-
  lc2018_tidy %>% 
  filter(!compound %in% c("Catechin gallate", "Theophylline")) %>% #all zeros for all samples
  mutate(conc_ug_mg = ifelse(is.na(conc_ug_mg), 0.0001, conc_ug_mg)) 

lc2018_2 <- 
  lc2018 %>% 
  mutate_all(~ifelse(is.na(.), 0.0001, .)) %>% 
  select(-`Catechin gallate`, -Theophylline) #all zeroes
```

## Examine correlations

```{r}
corrr::correlate(lc2017_2[11:23]) %>% 
  corrr::shave() %>% 
  corrr::rplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "2017")

corrr::correlate(lc2018_2[11:22]) %>% 
  corrr::shave() %>% 
  corrr::rplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "2018")
```

There are some strong correlations, so multivariable methods might be best?

# 2017
## RDA

Probably RDA is better since there are some correlations?


1. Fit RDA model

```{r}
lc2017_scaled <-
  lc2017_2 %>%
  mutate_at(vars(Caffeine:Theophylline), scale)

rda.2017 <-
  rda(lc2017_scaled %>% select(Caffeine:Theophylline) ~ mean_percent_damage, data = lc2017_scaled)
```


2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda.2017)
```

Only 11.62%

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda.2017)
```

Marginally significant effect of leaf damage on metabolites

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda.2017)
```

Marginally significant effect of leaf damage on metabolites.

5. Loadings

```{r}
# MVA.scores(dbrda_dens)

scores <- MVA.scores(rda.2017)$coord
loads <- MVA.load(rda.2017)$loads %>% rename(loading = `Constr. comp. 1`)

data <- lc2017_2 %>% select(Caffeine:Theophylline)


lc_biomarkers_2017 <-
  map_df(data, ~cor.test(.x, scores[["Constr. comp. 1"]]) %>% broom::glance(), .id = "compound") %>%
  bind_cols(loads) %>%
  mutate(p.adj = p.adjust(p.value, "fdr")) %>% 
  filter(p.adj < 0.05) %>%
  select(compound, loading, correlation = estimate, p.value, p.adj) %>% 
  arrange(desc(abs(loading)))
lc_biomarkers_2017
```


Top contributors: EGCG, Caffeine, Theobromine, ECG.  All negative relationship with mean % damage.

## Plots

```{r}
lc_plotdata.2017 <- lc2017_tidy %>% filter(compound %in% pull(lc_biomarkers_2017, compound))
lc_plot.2017 <-
  ggplot(lc_plotdata.2017, aes(x = mean_percent_damage, y = conc_ug_mg, color = compound)) +
  geom_point() +
  # geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~compound, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Mean % leaf damage",
       y = "Concentration (µg/mg)")
lc_plot.2017
```

```{r}
save_plot(here("figs", "lc_biomarker_plot_2017.png"), lc_plot.2017,
          ncol = 2,
          nrow = 2,
          base_height = 2,
          base_asp = 1.3)
```

# 2018


## Checking effect of processing time
In this year, I was unable to keep samples refridgerated as I processed them (scanning, then microwaving, then drying).  Scanning was the bottleneck step, so the first samples spent a lot less time sitting out on the counter after being harvested than the last samples.  To check for an effect of sample order, I pulled the file creation times from all the scanned images and merged them with the data.  Then, I used the time the scan was created as a conditional variable in an RDA.  It only explained about 1% of the variation in the LCMS compounds, so I won't use it as a covariate going forward.

```{r eval=FALSE}
jgy_path <- "/Volumes/as_rsch_orianslab_tea01$/Image Analysis/2018/Leaf Scans/Manipulative/Jin Guan Yin"
lj_path <- "/Volumes/as_rsch_orianslab_tea01$/Image Analysis/2018/Leaf Scans/Manipulative/Longjing"

jgy_info <-
  dir(jgy_path, "*.jpg", full.names = TRUE) %>%
  file.info() %>% 
  as_tibble(rownames = "paths") %>% 
  mutate(plant_num = str_extract(paths, "\\d+(?=\\w?\\.jpg$)")) %>% 
  mutate(sample = paste0("J", plant_num)) %>% 
  mutate(mtime = if_else(sample == "J18",
                         ymd_hms("2018-07-30 23:17:00") + hours(4),
                         mtime)) %>% 
  mutate(time = mtime - min(mtime))

lj_info <-
  dir(lj_path, "*.png", full.names = TRUE) %>% 
  file.info() %>% 
  as_tibble(rownames = "paths") %>% 
  mutate(plant_num = str_extract(paths, "\\d+(?=\\w?\\.png$)")) %>% 
  mutate(sample = paste0("L", plant_num)) %>% 
  mutate(time = mtime - min(mtime))

processing_time <-
  bind_rows(jgy_info, lj_info) %>% 
  select(sample, plant_num, time) %>% 
  group_by(sample) %>% 
  summarize(time = min(time))
```

```{r eval=FALSE}
lc2018_scaled <- 
  lc2018_2 %>% 
  mutate_at(vars(Caffeine:Theobromine), scale) %>% 
  mutate(cultivar = as.factor(cultivar)) %>% 
  left_join(processing_time)

rda.2018 <- 
  rda(lc2018_scaled %>% select(Caffeine:Theobromine) ~ mean_percent_damage*cultivar + Condition(as.numeric(time)),
      data = lc2018_scaled)
```

```{r eval=FALSE}
MVA.synt(rda.2018)
```

## RDA using leaf damage

1. Fit RDA model

```{r}
lc2018_scaled <- 
  lc2018_2 %>% 
  mutate_at(vars(Caffeine:Theobromine), scale) %>% 
  mutate(cultivar = as.factor(cultivar))

rda.2018 <- 
  rda(lc2018_scaled %>% select(Caffeine:Theobromine) ~ mean_percent_damage*cultivar,
      data = lc2018_scaled)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda.2018)
```

Experimental design explains 32.36% of variation in LCMS compounds

3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda.2018)
```

Highly significant global effect

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda.2018)
```

Significant effect of cultivar, no effect of damage.

5. Loadings

```{r}
loads2018 <-
  rda.2018$CCA$v %>% 
  as_tibble(rownames = "compound") %>% 
  arrange(desc(abs(RDA1)))


MVA.plot(rda.2018, 
         fac = lc2018_scaled$cultivar,
         drawextaxes = FALSE,
         main = "LCMS compounds",
         main.pos = "topleft")

ts2018 <-
  lc2018_tidy %>% 
  group_by(compound) %>%
  nest() %>% 
  mutate(ttest = map(data, ~t.test(conc_ug_mg~cultivar, .x)%>% tidy())) %>% 
  unnest(ttest) %>% 
  select(compound, d = estimate, J_conc = estimate1, L_conc = estimate2, p.value) %>% 
  mutate(p.adj = p.adjust(p.value, "fdr"))

full_join(loads2018, ts2018) %>% arrange(desc(abs(RDA1)))

lc2018_tidy %>% filter(compound == "Theobromine") %>% t.test(conc_ug_mg~cultivar, .)
```

Cultivar differences mainly in Theobromine, Gallocatechin, Epigallocatechin and Caffeine with all of them lower in Jin Guan Yin


## RDA using leafhopper density

1. Fit RDA model

```{r}
rda.2018.dens <- 
  rda(lc2018_scaled %>% select(Caffeine:Theobromine) ~ density_end*cultivar,
      data = lc2018_scaled)
```

2. How much total variance does the experimental design explain?

```{r}
MVA.synt(rda.2018.dens)
```


3. Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of the experimental design:

```{r}
anova(rda.2018.dens)
```

Highly significant global effect

4. Then we test for significance of individual factors and interaction terms:

```{r}
MVA.anova(rda.2018.dens)
```

Significant effect of cultivar, no effect of density