---
title: "Method file construction for 2018 Shengzhou DCSE experiment"
output: html_notebook
---
# Start Project
First, start a new project in Ion Analytics.  Import the alkane mix .D file and either import a previous alkane method or create one using automated method construction.  Run the method on the alkane file, and export the results from the integration report tab.

# Load packages
```{r}
library(tidyverse)
library(here)
library(chemhelper)
```

# Load files

- Master list of RIs
- Old method file (Compound List)
- New Alkane file (integration report)

```{r}
# RImaster <- read_csv("/Users/scottericr/Box/IonAnalytics/method_master RIs.csv")
RImaster <- read_csv("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/method_master RIs.csv")

# oldmethod <- read_IA("/Users/scottericr/Box/IonAnalytics/IonAnalytics Projects/BACE 2017/Methods/BACE_MS-Subtraction/BACE_MS-Subtraction Compounds list.csv")

alkanes <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data/073018_alkanemix/Meth_073018_alkanemix Integration Report.csv")
```

# Make alkane table
Look at alkanes available, add column of carbon number, use actual retention times whenever possible, otherwise use expected RTs.

```{r}
alkanes_new <-
  alkanes %>% 
  slice(1:19) %>%  #that's enough I think.
  mutate(rt = ifelse(`R.Time [min.]` == 0, `Expect. [min.]`, `R.Time [min.]`)) %>% 
  select(Compound, rt) %>% 
  add_column(C_num = 6:24)
```

# Merge RIs with old method file

```{r}
shengzhou <- left_join(oldmethod, select(RImaster, Compound, RI_exp))
shengzhou
anyNA(shengzhou$RI_exp)
```

# Back-calculate RTs from master RI file

```{r}
method_new <-
  shengzhou %>% 
  mutate(RT_exp = calc_RT(RI_exp, alkanes_new$rt, alkanes_new$C_num),
         from = RT_exp - 0.5,
         to = RT_exp + 0.5,
         sumfrom = RT_exp - 1,
         sumto = RT_exp + 1)
method_new
```

# Write to file for copy-pasting into IonAnalytics

Import the same methods file you used as `oldmethod` into your new IA project.  Open it up and copy and paste these values.

```{r}
write_csv(method_new, here("R", "ion_analytics", "2018_adjusted_method_RTs.csv"))
```


# Adjusting method for Jin Guan Yin

The Twisters for Longjing were run at a different time than the twisters for the Jin Guan Yin plants and there was instrument drift.  I have alkane files for both runs.  I've already made a bunch of changes to retention windows and settings for the Longjing method, so I want to copy it and only adjust the RTs while keeping the same window width and all that.

## Read in adjusted longjing method and both alkane files

```{r}
lj_alkane_raw <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data/073018_alkanemix/Meth_073018_alkanemix Integration Report.csv")

jgy_alkane_raw <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Data/082018_Alkane/Meth_073018_alkanemix Integration Report.csv")

lj_method_adj <- read_IA("/Volumes/as_rsch_orianslab_tea01$/IonAnalytics/IonAnalytics Projects/Shengzhou_2018/Methods/Shengzhou_adj/Shengzhou_adj Compounds list.csv")

lj_method_adj %>% summarize(max(`Ret.Time [min.]`))
```

## Make alkane tables
Look at alkanes available, add column of carbon number, use actual retention times whenever possible, otherwise use expected RTs.

```{r}
lj_alkane <-
  lj_alkane_raw %>% 
  slice(1:19) %>%  #that's enough I think.
  mutate(rt = ifelse(`R.Time [min.]` == 0, `Expect. [min.]`, `R.Time [min.]`)) %>% 
  select(Compound, rt) %>% 
  add_column(C_num = 6:24)

jgy_alkane <-
  jgy_alkane_raw %>% 
  slice(1:19) %>%  #that's enough I think.
  mutate(rt = ifelse(`R.Time [min.]` == 0, `Expect. [min.]`, `R.Time [min.]`)) %>% 
  select(Compound, rt) %>% 
  add_column(C_num = 6:24)
```

## Calculate RIs from old method file and new RTs from new alkane file

```{r}
jgy_method_adj <-
  lj_method_adj %>%
  mutate(RI = calc_RI(`Ret.Time [min.]`, lj_alkane$rt, lj_alkane$C_num)) %>% #calc RI based on alkane file
  mutate(RT_adj = calc_RT(RI, jgy_alkane$rt, jgy_alkane$C_num)) %>% #adjust RT based on new alkanes
  mutate(half_window = round(`...to [min.]` - `Ret.Time [min.]`, 3), #keep integration window size
         from_adj = RT_adj - half_window,
         to_adj = RT_adj + half_window) %>% 
  select(No., Compound, RT_adj, from_adj, to_adj) #order columns to make for easier copying and pasting
```

## Write to CSV
Write this to csv then copy and paste into a copy of the method used for Long Jing samples.

```{r}
write_csv(jgy_method_adj, here("R", "ion analytics", "2018_adjusted_method_RTs_JGY.csv"))
```

