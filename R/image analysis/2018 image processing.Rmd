---
title: "2018 Leaf Scan Analysis"
output: html_notebook
---

Date initiated: 2019-05-06
Date compiled: `r Sys.Date()`
```{r}
library(here)
library(tidyverse)
library(glue)
```

# Choose random images for training set

First, copy a random subset of files to use as a training set.

```{r}
scandir <- "/Users/scottericr/Box/Image Analysis/2018/Leaf Scans/Manipulative"
leaves <- list.files(scandir, recursive = TRUE, pattern = "leaf.+\\.png", full.names = FALSE)
length(leaves)



df <- tibble(path = leaves)
df <- df %>%
  mutate(cultivar = str_extract(path, "^[^/]+(?=/)"),
         scan = str_extract(path, "(?<=/).+(?=/)"),
         leaf = str_extract(path, "[^/]+(?=.png)")) %>% 
  mutate(new.filename = glue("{scan}_{leaf}.png"),
         from.path = glue("{scandir}/{path}"),
         to.path = glue("{scandir}/Training Sample/{new.filename}"))

# runif(1, 1, 1000)
set.seed(688)
train <- df %>% group_by(cultivar) %>% sample_n(15) %>% ungroup()
# file.copy(from = train$from.path, to = train$to.path) #DO NOT UNCOMMENT THIS.  THE ACTUAL TEST SET DOESN"T MATCH THESE FILES.  I MUST HAVE CHANGED THE SEED OR SOMETHING BY ACCIDENT.
```

Output a list of file paths. This can be used by FIJI in file > import > Stack From List... to make a virtual stack. However, I think it crops and/or resizes leaves, which isn't optimal.

```{r}
# write_csv(select(train, to.path), glue("{scandir}/Training Sample/file_list.csv"),col_names = FALSE)
train_set <- list.files(glue("{scandir}/Training Sample"), pattern = "*.png", full.names = TRUE) 

# train_set %>% 
#   write_lines(glue("{scandir}/Training Sample/file_list.csv"))
```

Instead, I should open all the images and convert to stack manually. 


# Training the classifier

I trained the classifier using these images with the following settings:

Training features:

- Hessian
- Sobel
- Variance
- Minimum
- Median
- Anisotropic
- Bilateral

With a minimum sigma of 2 and a maximum of 16

These settings gave the lowest out of bag error.  The training set included some folded leaves and some dead leaves, which I might eventually exclude from the final data, but I think that's ok.

I saved the data and classifier as `full_stack_classifier.model` and `full_stack_data.aarf`.

I loaded these into the WEKA experimenter and saved the experiment as `full_stack_experiment.exp`.  I loaded the explorer and found kappa = 0.996.  However, this is using the classifier on the training set.  I need to make a test set to do this properly

# Making a test set.

```{r}
set.seed(509)
test_set <-
  df %>%
  # filter(!to.path %in% train_set) %>%
  filter(!str_detect(path, "Training")) %>%   #exclude training samples
  group_by(cultivar) %>% 
  sample_n(5) %>%  #get 5 from each CV to test classifier on
  ungroup() %>% 
  mutate(to.path = str_replace(to.path, "Training Sample", "Test Sample"))
test_set

file.copy(from = test_set$from.path, to = test_set$to.path)
```








I've previously used this macro to automatically make stacks.  I should edit it to make stacks of ~30 for later.

```{javascript}
dir = getDirectory("choose a folder");

list = getFileList(dir);
nstacks = -floor(-list.length/5);
print(nstacks);
stacksize = round(list.length/nstacks);

//for each stack:
for(n=0; n<nstacks; n++){
	//open the first set of files
	files = Array.slice(list, stacksize*(n), stacksize*(n+1));
	for (i=0; i<files.length; i++){
			open(files[i]);
		}
	run("Images to Stack", "method=[Copy (top-left)] name=Stack title=[] use");
	width = getWidth;
	height = getHeight;
	setColor("white");
	for (j=1; j<=nSlices; j++){
		setSlice(j);
		floodFill(width-1, height-1);
	}

	saveAs("tiff", dir + "/Stack_" + n + ".tif");
	close();
}
```

